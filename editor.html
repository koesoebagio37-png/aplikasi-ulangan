<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Soal (AI & Secure) - Comfort & Glow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'cyber': { 900: '#02120a', 800: '#051f15', 700: '#064e3b', 500: '#10b981', 400: '#34d399' },
                        'soft': { bg: '#fdfbf7', card: '#ffffff', border: '#e8e6e1', text: '#4a4a4a', primary: '#6b7280' }
                    },
                    boxShadow: {
                        'glow-green': '0 0 15px -3px rgba(16, 185, 129, 0.4)',
                        'glow-input': '0 0 0 2px rgba(52, 211, 153, 0.3)',
                        'soft-card': '0 4px 20px -2px rgba(200, 190, 180, 0.2)',
                    }
                }
            }
        }
    </script>
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d6d3cf; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #064e3b; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #10b981; }

        #editor-live-preview { line-height: 1.7; }
        #editor-live-preview p { margin-bottom: 0.75rem; }
        #editor-live-preview ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.75rem; }
        #editor-live-preview ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 0.75rem; }
        #editor-live-preview li { margin-bottom: 0.25rem; }

        /* Toolbar Styles */
        .editor-toolbar {
            display: flex; flex-wrap: wrap; gap: 4px; padding: 8px;
            background: #f8fafc; border-bottom: 1px solid #e2e8f0;
            border-radius: 0.75rem 0.75rem 0 0; position: relative;
        }
        .dark .editor-toolbar { background: #1e293b; border-color: #374151; }
        
        .tool-btn, .tool-select {
            padding: 4px 8px; border-radius: 4px; font-size: 13px; color: #475569;
            background: white; border: 1px solid #cbd5e1; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .dark .tool-btn, .dark .tool-select {
            background: #0f172a; border-color: #334155; color: #cbd5e1;
        }
        .tool-btn:hover { background: #e2e8f0; }
        .dark .tool-btn:hover { background: #334155; }
        .tool-btn.active { background: #cbd5e1; color: black; border-color: #94a3b8; }
        
        /* Text Editor Area */
        #question-text-visual {
            min-height: 250px; max-height: 500px; overflow-y: auto;
            padding: 16px; outline: none; border: 1px solid #e2e8f0; border-top: none;
            border-radius: 0 0 0.75rem 0.75rem; background: white;
        }
        .dark #question-text-visual {
            background: #02120a; border-color: #374151; color: white;
        }
        #question-text-visual ul { list-style-type: disc; margin-left: 20px; }
        #question-text-visual ol { list-style-type: decimal; margin-left: 20px; }
        #question-text-visual b { font-weight: bold; }
        #question-text-visual i { font-style: italic; }
        #question-text-visual u { text-decoration: underline; }

        /* MATH KEYBOARD */
        #math-keyboard {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 4px; padding: 8px; background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0; border-top: 1px solid #e2e8f0;
        }
        .dark #math-keyboard { background: #0f172a; border-color: #374151; }
        .math-key {
            padding: 6px; background: white; border: 1px solid #cbd5e1;
            border-radius: 4px; text-align: center; cursor: pointer; font-family: 'Times New Roman', serif;
            font-size: 1.1rem; transition: all 0.1s;
        }
        .math-key:hover { transform: scale(1.1); background: #e2e8f0; }
        .dark .math-key { background: #1e293b; border-color: #334155; color: white; }
        .dark .math-key:hover { background: #334155; }

        /* Preview Styles */
        .editor-image-preview { max-height: 80px; border-radius: 0.5rem; border: 2px solid #e5e7eb; }
        .dark .editor-image-preview { border-color: #064e3b; }
        .soal-body-image { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 0.5rem 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .options-container { display: none; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        input, textarea, select { transition: all 0.3s ease; }

        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); } 50% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); } }
        .dark .btn-glow:hover { animation: pulse-glow 2s infinite; border-color: #34d399; }
				/* STYLE UNTUK TABEL DI EDITOR & PREVIEW */
		.generated-table {
			width: 100%;
			border-collapse: collapse;
			margin: 10px 0;
			font-size: 0.9em;
		}
		.generated-table th, .generated-table td {
			border: 1px solid #cbd5e1; /* Warna garis abu-abu */
			padding: 8px;
			min-width: 30px;
		}
		.dark .generated-table th, .dark .generated-table td {
			border-color: #475569; /* Warna garis mode gelap */
		}
		.generated-table th {
			background-color: #f1f5f9;
			font-weight: bold;
			text-align: center;
		}
		.dark .generated-table th {
			background-color: #1e293b;
			color: white;
		}
    </style>
</head>
<body class="bg-soft-bg text-soft-text dark:bg-cyber-900 dark:text-emerald-50 transition-colors duration-500 flex flex-col h-screen overflow-hidden">

	<!-- LOGIN OVERLAY (SECURITY) -->
    <div id="login-overlay" class="fixed inset-0 z-[100] bg-gray-100 dark:bg-cyber-900 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-cyber-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-emerald-900">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-indigo-100 dark:bg-emerald-900/50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">ðŸ”’</div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Login Admin</h2>
                <p class="text-gray-500 text-sm">Akses Khusus Guru/Administrator</p>
            </div>
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1 dark:text-gray-300">Email</label>
                    <input type="email" id="admin-email" class="w-full p-3 rounded-lg border dark:bg-cyber-900 dark:border-gray-700 dark:text-white" required placeholder="admin@sekolah.com">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 dark:text-gray-300">Password</label>
                    <input type="password" id="admin-password" class="w-full p-3 rounded-lg border dark:bg-cyber-900 dark:border-gray-700 dark:text-white" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg">Masuk Sistem</button>
            </form>
            <p id="login-error-msg" class="text-red-500 text-center text-sm mt-4 hidden"></p>
        </div>
    </div>
    <!-- Notifikasi Toast -->
    <div id="notification-toast" class="fixed top-6 right-6 z-[100] max-w-md p-4 rounded-xl shadow-soft-card dark:shadow-glow-green transform transition-all duration-300 translate-x-[150%] backdrop-blur-md border border-white/40 dark:border-emerald-500/30 flex items-center gap-3 font-medium">
        <span id="notification-message">Notifikasi</span>
    </div>

    <!-- Header -->
    <header class="flex-none bg-[#fdfbf7]/80 dark:bg-cyber-900/80 backdrop-blur-lg border-b border-soft-border dark:border-emerald-900 z-20 sticky top-0 transition-colors duration-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-100 dark:bg-emerald-900/50 p-2 rounded-lg border border-indigo-200 dark:border-emerald-500 shadow-sm dark:shadow-glow-green transition-all duration-500">
                    <svg class="w-10 h-10 text-indigo-500 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-soft-text dark:text-emerald-50 leading-tight">
                        EDITOR <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 dark:from-emerald-400 dark:to-teal-300">SOAL</span>
                    </h1>
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold text-green-600 dark:text-green-400 uppercase tracking-widest border border-green-500/30 px-1 rounded">SECURE</span>
                            <span class="text-[10px] font-bold text-purple-600 dark:text-purple-400 uppercase tracking-widest border border-purple-500/30 px-1 rounded">AI READY</span>
                        </div>
                        <span class="text-[9px] font-bold text-gray-400 dark:text-emerald-500/40 tracking-[0.3em] mt-0.5 pl-0.5">Compiled by Koes</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button id="open-bank-soal-btn" class="hidden md:flex items-center gap-2 bg-white dark:bg-cyber-800 hover:bg-gray-50 dark:hover:bg-cyber-700 text-soft-text dark:text-emerald-200 px-4 py-2 rounded-full text-sm font-medium transition-all border border-soft-border dark:border-emerald-800 dark:hover:border-emerald-500 dark:hover:shadow-glow-green">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                    Bank Soal
                </button>
				<button id="logout-btn" class="bg-red-100 text-red-600 px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-200 transition-colors ml-2 hidden">Keluar</button>
                <div class="w-px h-6 bg-gray-300 dark:bg-emerald-900 mx-1"></div>
                <button id="dark-mode-toggle" class="p-2 rounded-full bg-indigo-50 dark:bg-cyber-800 text-indigo-400 dark:text-emerald-400 hover:bg-indigo-100 dark:hover:bg-cyber-700 transition-all focus:outline-none ring-2 ring-transparent focus:ring-indigo-300 dark:focus:ring-emerald-500">
                    <svg id="theme-icon-sun" class="w-5 h-5 hidden"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg id="theme-icon-moon" class="w-5 h-5 hidden"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden relative">
        <div class="h-full overflow-y-auto p-4 md:p-6 lg:p-8 scroll-smooth">
            <div id="editor-container" class="max-w-6xl mx-auto space-y-6 pb-24">
                
                <!-- Card: Tipe Soal -->
                <div class="bg-white dark:bg-cyber-800 rounded-2xl shadow-soft-card dark:shadow-none border border-soft-border dark:border-emerald-900/50 p-6">
                    <label class="block text-xs font-bold uppercase tracking-wider text-gray-400 dark:text-emerald-500/70 mb-2">Tipe Soal</label>
                    <div class="relative">
                        <select id="question-type" class="w-full bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 text-gray-700 dark:text-emerald-100 text-sm rounded-xl focus:ring-2 focus:ring-indigo-300 dark:focus:ring-emerald-500 block p-3">
                            <option value="pg">Pilihan Ganda (PG)</option>
                            <option value="pgk">Pilihan Ganda Kompleks (PGK)</option>
                            <option value="bs">Benar/Salah (BS)</option>
                            <option value="esai-singkat">Esai Singkat</option>
                            <option value="esai-kompleks">Esai Kompleks (Uraian)</option>
                        </select>
                    </div>
                </div>

                <!-- Card: Metadata -->
                <div class="bg-white dark:bg-cyber-800 rounded-2xl shadow-soft-card dark:shadow-none border border-soft-border dark:border-emerald-900/50 p-6">
                    <h2 class="text-sm font-bold text-gray-600 dark:text-emerald-100 border-b border-gray-100 dark:border-emerald-900 pb-3 mb-4 flex items-center gap-2">
                        <span class="w-2 h-6 bg-indigo-300 dark:bg-emerald-500 rounded-full shadow-lg"></span>
                        METADATA SOAL
                    </h2>
					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
						<!-- TAMBAHAN: MATA PELAJARAN -->
						<div class="space-y-1">
							<label class="text-xs font-medium text-gray-500 dark:text-emerald-400/80">Mata Pelajaran</label>
							<input type="text" id="meta-mapel" list="mapel-list" class="w-full bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-lg px-3 py-2 text-sm text-gray-700 dark:text-emerald-50 outline-none" placeholder="Cth: Matematika">
							<datalist id="mapel-list"></datalist>
						</div>

						<div class="space-y-1">
							<label class="text-xs font-medium text-gray-500 dark:text-emerald-400/80">Kelas</label>                            <select id="meta-kelas" class="w-full bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-lg px-3 py-2 text-sm text-gray-700 dark:text-emerald-50 outline-none cursor-pointer">
                                <option value="" disabled selected>Pilih Kelas</option>
                                <option value="X">Kelas X</option>
                                <option value="XI">Kelas XI</option>
                                <option value="XII">Kelas XII</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500 dark:text-emerald-400/80">Level Kognitif</label>
                            <select id="meta-kesulitan" class="w-full bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-lg px-3 py-2 text-sm text-gray-700 dark:text-emerald-50 outline-none">
                                <option value="C1">C1 (Mengingat)</option>
                                <option value="C2">C2 (Memahami)</option>
                                <option value="C3">C3 (Menerapkan)</option>
                                <option value="C4">C4 (Menganalisis)</option>
                                <option value="C5">C5 (Mengevaluasi)</option>
                                <option value="C6">C6 (Mencipta)</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500 dark:text-emerald-400/80">BAB (Materi)</label>
                            <input type="text" id="meta-bab" list="bab-list" class="w-full bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-lg px-3 py-2 text-sm text-gray-700 dark:text-emerald-50 outline-none" placeholder="Pilih atau Ketik Baru">
                            <datalist id="bab-list"></datalist>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500 dark:text-emerald-400/80">Sub BAB</label>
                            <input type="text" id="meta-subbab" list="subbab-list" class="w-full bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-lg px-3 py-2 text-sm text-gray-700 dark:text-emerald-50 outline-none" placeholder="Pilih atau Ketik Sub Bab">
                            <datalist id="subbab-list"></datalist>
                        </div>
                    </div>
                </div>

                <!-- Grid: Editor & Preview -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Kolom Kiri: Input Naskah (NEW VISUAL EDITOR) -->
                    <div class="bg-white dark:bg-cyber-800 rounded-2xl shadow-soft-card dark:shadow-none border border-soft-border dark:border-emerald-900/50 flex flex-col h-full overflow-hidden">
                        <div class="flex justify-between items-center p-4 border-b border-gray-100 dark:border-emerald-800 bg-gray-50 dark:bg-cyber-900/30">
                            <label class="text-sm font-bold text-gray-600 dark:text-emerald-100">Naskah Soal</label>
                            <span class="text-xs text-gray-400 italic">Support Text & LaTeX ($..$)</span>
                        </div>

                        <!-- TOOLBAR -->
                        <div class="editor-toolbar">
                            <select class="tool-select" onchange="execCmd('fontName', this.value)">
                                <option value="Inter">Default Font</option>
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Courier New">Courier New</option>
                            </select>
                            <select class="tool-select" onchange="execCmd('fontSize', this.value)">
                                <option value="3">12pt</option><option value="1">8pt</option><option value="4">14pt</option><option value="5">18pt</option>
                            </select>
                            <div class="w-px h-5 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                            <button class="tool-btn font-bold" onclick="execCmd('bold')" title="Bold">B</button>
                            <button class="tool-btn italic" onclick="execCmd('italic')" title="Italic">I</button>
                            <button class="tool-btn underline" onclick="execCmd('underline')" title="Underline">U</button>
                            <div class="w-px h-5 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                            <button class="tool-btn" onclick="execCmd('justifyLeft')" title="Rata Kiri"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M3 18h12v-2H3v2zM3 6v2h18V6H3zm0 7h18v-2H3v2z"/></svg></button>
                            <button class="tool-btn" onclick="execCmd('justifyCenter')" title="Rata Tengah"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M7 18h10v-2H7v2zM3 6v2h18V6H3zm4 7h14v-2H7v2z"/></svg></button>
                            <button class="tool-btn" onclick="execCmd('justifyRight')" title="Rata Kanan"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M9 18h12v-2H9v2zM3 6v2h18V6H3zm0 7h14v-2H3v2z"/></svg></button>
                            <button class="tool-btn" onclick="execCmd('justifyFull')" title="Rata Kiri Kanan"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>

                            <div class="w-px h-5 bg-gray-300 dark:bg-gray-600 mx-1"></div>

                            <!-- Lists -->
                            <button class="tool-btn" onclick="execCmd('insertUnorderedList')" title="Bullet List (â€¢)">â€¢ List</button>
                            <button class="tool-btn" onclick="execCmd('insertOrderedList')" title="Number List (1.)">1. List</button>
                            <div class="w-px h-5 bg-gray-300 dark:bg-gray-600 mx-1"></div>

							<!-- TOMBOL TABEL BARU -->
							<button class="tool-btn" onclick="insertTable()" title="Buat Tabel">
								<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7-4h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
							</button>
							
                            <!-- MATH KEYBOARD TOGGLE -->
                            <button class="tool-btn text-indigo-600 border-indigo-200 dark:text-indigo-400 dark:border-indigo-800 ml-auto" onclick="toggleMathKeyboard()" title="Simbol Matematika">
                                <span class="font-serif font-bold text-lg">Î±</span>
                            </button>
                        </div>
                        
                        <!-- MATH KEYBOARD -->
                        <div id="math-keyboard"></div>
                        
                        <!-- CONTENT EDITABLE DIV -->
						<!-- CONTENT EDITABLE DIV (ATAS) -->
						<div id="question-text-visual" contenteditable="true" class="min-h-[120px] p-4 outline-none border-b border-dashed border-gray-300 dark:border-gray-700" placeholder="Tulis teks ATAS gambar di sini..."></div>

						<!-- AREA PEMISAH (TEMPAT GAMBAR MUNCUL SECARA VISUAL) -->
						<div class="bg-gray-100 dark:bg-black/20 py-2 px-4 text-xs font-bold text-center text-gray-400 dark:text-emerald-500/50 uppercase tracking-widest select-none">
							--- Posisi Gambar ---
						</div>

						<!-- CONTENT EDITABLE DIV (BAWAH) - BARU -->
						<div id="question-text-bottom" contenteditable="true" class="min-h-[100px] flex-1 p-4 outline-none" placeholder="Tulis teks BAWAH gambar di sini..."></div>
                        <!-- Image Toolbar (Footer) -->
                        <div class="p-3 bg-gray-50 dark:bg-cyber-900 border-t border-gray-100 dark:border-emerald-800 flex flex-wrap items-center gap-2">
						<!-- Tombol Upload -->
							<label class="cursor-pointer flex items-center gap-1 text-[10px] font-bold text-indigo-600 dark:text-emerald-400 hover:text-indigo-800 transition-colors">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
								UPLOAD
								<input type="file" id="naskah-image-input" class="file-input hidden" accept="image/*,application/pdf">
							</label>
							
							<div class="h-4 w-px bg-gray-300 dark:bg-emerald-800"></div>
							
							<button type="button" class="url-btn text-[10px] font-bold text-gray-500 hover:text-gray-700" data-target="naskah">ðŸ”— URL</button>

							<div class="h-4 w-px bg-gray-300 dark:bg-emerald-800"></div>

							<!-- WRAPPER BARU UNTUK PINDAI (Mencegah Menumpuk) -->
							<div class="flex items-center gap-1 bg-white dark:bg-cyber-800 p-0.5 rounded border border-gray-200 dark:border-emerald-700">
								<!-- Pilihan Mode -->
								<select id="scan-mode" class="bg-transparent text-[9px] font-bold text-amber-600 outline-none px-1 border-r border-gray-100 dark:border-emerald-900 cursor-pointer">
									<option value="soal_saja">Hanya Soal</option>
									<option value="dengan_kunci" selected>+ Kunci</option>
								</select>

								<!-- Tombol Pindai -->
								<button id="btn-scan-ocr" type="button" class="text-[9px] font-bold text-amber-700 dark:text-amber-400 px-2 py-1 hover:bg-amber-50 dark:hover:bg-amber-900/30 transition-colors">
									âœ¨ PINDAI AI
								</button>

								<!-- Garis Pembatas Kecil -->
								<div class="h-3 w-px bg-gray-200 dark:bg-emerald-900 mx-0.5"></div>

								<!-- Tombol Ganti Key (Baru) -->
								<button onclick="if(confirm('Hapus kunci AI yang tersimpan? Anda akan diminta memasukkan kunci baru saat klik Pindai/AI.')){localStorage.removeItem('gemini_api_key_soal');}" 
										type="button" 
										class="text-[9px] font-bold text-gray-400 hover:text-red-500 px-1.5 py-1 transition-colors" 
										title="Klik jika ingin ganti akun atau kunci error">
									ðŸ”„ Ganti Key
								</button>
							</div>

							<!-- Preview Kecil (Tetap di Kanan) -->
							<div id="naskah-image-preview-container" class="editor-image-preview-container ml-auto hidden relative group">
								<img id="naskah-image-preview" src="" class="h-8 w-8 object-cover rounded border border-gray-300">
								<button type="button" class="remove-image-btn absolute -top-1 -right-1 bg-rose-400 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px]" data-target="naskah">&times;</button>
							</div>
							<input type="hidden" id="naskah-image-base64" value="">
						</div>
                    </div>

                    <!-- Kolom Kanan: Live Preview -->
                    <div class="bg-white dark:bg-cyber-800 rounded-2xl shadow-soft-card dark:shadow-none border border-soft-border dark:border-emerald-900/50 p-6 flex flex-col h-full relative overflow-hidden">
                         <div class="absolute top-0 right-0 bg-indigo-400 dark:bg-emerald-600 text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl shadow-md dark:shadow-glow-green">LIVE PREVIEW</div>
                         <label class="text-sm font-bold text-gray-600 dark:text-emerald-100 mb-3">Tampilan Siswa</label>
                         
                         <div class="flex-1 bg-[#faf9f6] dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-xl p-5 overflow-y-auto shadow-inner">
                            <div id="editor-live-preview" class="text-gray-700 dark:text-emerald-50 prose dark:prose-invert max-w-none">
                                <div class="flex flex-col items-center justify-center h-40 text-gray-400 dark:text-emerald-500/50">
                                    <p class="text-sm italic">Mulai ketik untuk melihat hasil...</p>
                                </div>
                            </div>
                         </div>
                    </div>

                </div>

                <!-- Card: Opsi Jawaban -->
                <div class="bg-white dark:bg-cyber-800 rounded-2xl shadow-soft-card dark:shadow-none border border-soft-border dark:border-emerald-900/50 p-6">
                    
                    <!-- PG Container -->
                    <div id="options-pg" class="options-container space-y-4">
                        <div class="flex justify-between items-end border-b border-gray-100 dark:border-emerald-900 pb-2 mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-700 dark:text-emerald-50">Opsi Jawaban</h3>
                                <p class="text-xs text-gray-500 dark:text-emerald-400/60">Pilihan Ganda Biasa (Pilih Kunci Jawaban dengan Radio Button)</p>
                            </div>
                            <button id="add-pg-option" class="btn-glow text-xs font-bold text-indigo-600 dark:text-emerald-400 hover:text-indigo-800 dark:hover:text-emerald-200 flex items-center gap-1 px-3 py-1 rounded border border-transparent hover:border-indigo-200 dark:hover:border-emerald-500">
                                + TAMBAH OPSI
                            </button>
                        </div>
                        <div id="options-pg-list" class="space-y-3"></div>
                    </div>

                    <!-- PGK Container -->
                    <div id="options-pgk" class="options-container space-y-4">
                        <div class="flex justify-between items-end border-b border-gray-100 dark:border-emerald-900 pb-2 mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-700 dark:text-emerald-50">Opsi Jawaban Kompleks</h3>
                                <p class="text-xs text-gray-500 dark:text-emerald-400/60">Bisa lebih dari satu jawaban benar</p>
                            </div>
                            <button id="add-pgk-option" class="btn-glow text-xs font-bold text-indigo-600 dark:text-emerald-400 hover:text-indigo-800 flex items-center gap-1 px-3 py-1 rounded border border-transparent hover:border-indigo-200 dark:hover:border-emerald-500">
                                + TAMBAH OPSI
                            </button>
                        </div>
                        <div id="options-pgk-list" class="space-y-3"></div>
                    </div>

                    <!-- BS Container -->
                    <div id="options-bs" class="options-container space-y-4">
                        <div class="flex justify-between items-end border-b border-gray-100 dark:border-emerald-900 pb-2 mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-700 dark:text-emerald-50">Pernyataan Benar/Salah</h3>
                            </div>
                            <button id="add-bs-statement" class="btn-glow text-xs font-bold text-indigo-600 dark:text-emerald-400 hover:text-indigo-800 flex items-center gap-1 px-3 py-1 rounded border border-transparent hover:border-indigo-200 dark:hover:border-emerald-500">
                                + TAMBAH PERNYATAAN
                            </button>
                        </div>
                        <div id="options-bs-list" class="space-y-3"></div>
                    </div>

                    <!-- Esai Singkat -->
                    <div id="options-esai-singkat" class="options-container space-y-2">
                        <label class="block text-sm font-bold text-gray-700 dark:text-emerald-50">Kunci Jawaban Singkat</label>
                        <input type="text" id="kunci-jawaban-singkat" class="w-full bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-xl px-4 py-3 text-gray-700 dark:text-emerald-50 focus:ring-2 focus:ring-green-400 dark:focus:ring-emerald-500 outline-none" placeholder="Tulis jawaban yang benar disini...">
                    </div>

                    <!-- Esai Kompleks -->
                    <div id="options-esai-kompleks" class="options-container">
                        <div class="p-4 bg-indigo-50 dark:bg-emerald-900/20 rounded-xl border border-indigo-100 dark:border-emerald-800 text-indigo-700 dark:text-emerald-300 text-sm flex items-start gap-3">
                            <p>Soal tipe uraian tidak memiliki kunci jawaban otomatis. Koreksi akan dilakukan manual oleh guru.</p>
                        </div>
                    </div>
                </div>

                <!-- Card: Pembahasan (Updated with AI Button) -->
                <div class="bg-white dark:bg-cyber-800 rounded-2xl shadow-soft-card dark:shadow-none border border-soft-border dark:border-emerald-900/50 p-6">
                    <div class="flex items-center mb-4">
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="pembahasan-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 transform translate-x-0 checked:translate-x-4 checked:border-indigo-500 dark:checked:border-emerald-500"/>
                            <label for="pembahasan-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-cyber-900 cursor-pointer"></label>
                        </div>
                        <label for="pembahasan-toggle" class="text-sm font-bold text-gray-700 dark:text-emerald-50">Sertakan Pembahasan Soal?</label>
                    </div>
                    
                    <div id="pembahasan-container" class="mt-4 pt-4 border-t border-gray-100 dark:border-emerald-900" style="display: none;">
                        <textarea id="pembahasan-editor" rows="4" class="w-full bg-gray-50 dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 rounded-xl p-4 text-gray-700 dark:text-emerald-50 focus:ring-2 focus:ring-indigo-300 dark:focus:ring-emerald-500 outline-none resize-none" placeholder="Jelaskan kenapa jawabannya itu..."></textarea>
                        
                        <div class="mt-3 flex flex-wrap justify-between items-center gap-2">
                            <div class="flex items-center gap-3">
                                 <label class="cursor-pointer text-xs font-semibold text-indigo-600 hover:text-indigo-800 dark:text-emerald-400 dark:hover:text-emerald-200">
                                     + Gambar
                                     <input type="file" id="pembahasan-image-input" class="file-input hidden" accept="image/*">
                                 </label>
                                 <button type="button" class="url-btn text-xs text-gray-500 hover:text-gray-700 dark:text-emerald-500/70 dark:hover:text-emerald-300" data-target="pembahasan">Via URL</button>
                                 
                                 <div id="pembahasan-image-preview-container" class="editor-image-preview-container ml-auto hidden relative">
                                     <img id="pembahasan-image-preview" src="" class="h-10 w-10 object-cover rounded border border-gray-300">
                                     <button type="button" class="remove-image-btn absolute -top-2 -right-2 bg-rose-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs" data-target="pembahasan">&times;</button>
                                 </div>
                                 <input type="hidden" id="pembahasan-image-base64" value="">
                            </div>

                            <!-- TOMBOL AI -->
                            <button id="btn-ai-generate" type="button" class="flex items-center gap-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors border border-purple-200 dark:border-purple-700">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                âœ¨ Buat Pembahasan (AI)
                            </button>
                        </div>
                        <div id="ai-loading-indicator" class="hidden mt-2 text-xs text-purple-600 dark:text-purple-400 animate-pulse font-mono">âœ¨ AI sedang menganalisis soal & kunci jawaban...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sticky Action Bar -->
        <div class="fixed bottom-0 left-0 w-full bg-[#fdfbf7]/90 dark:bg-cyber-900/90 backdrop-blur border-t border-gray-200 dark:border-emerald-900 p-4 z-30 transition-colors duration-500">
            <div class="max-w-6xl mx-auto flex gap-3">
                <input type="hidden" id="edit-mode-id" value="">
                <button id="clear-editor-btn" class="flex-1 bg-gray-200 dark:bg-cyber-800 hover:bg-gray-300 dark:hover:bg-cyber-700 text-gray-700 dark:text-emerald-200 font-bold py-3 px-4 rounded-xl transition-all border border-transparent dark:border-emerald-900">Bersihkan</button>
                <button id="save-bank-soal-btn" class="btn-glow flex-[2] bg-gradient-to-r from-indigo-500 to-purple-500 dark:from-emerald-600 dark:to-teal-600 hover:from-indigo-600 hover:to-purple-600 dark:hover:from-emerald-500 dark:hover:to-teal-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all transform hover:-translate-y-0.5 border border-transparent dark:border-emerald-400">
                    <span class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        Simpan Aman (Secure)
                    </span>
                </button>
            </div>
        </div>
    </main>
    
    <!-- MODAL BANK SOAL -->
    <div id="bankSoalModal" class="modal fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/40 dark:bg-black/80 backdrop-blur-sm transition-opacity"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="modal-content relative transform overflow-hidden rounded-2xl bg-[#fffcf8] dark:bg-cyber-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-3xl border border-gray-200 dark:border-emerald-900">
                    
                    <div class="bg-gray-50 dark:bg-cyber-900 px-4 py-3 flex justify-between items-center border-b border-gray-200 dark:border-emerald-800">
                        <h3 class="text-lg font-bold leading-6 text-gray-700 dark:text-emerald-50" id="modal-title">Bank Soal</h3>
                        <button id="close-bank-soal-modal-btn" type="button" class="text-gray-400 hover:text-gray-500 dark:hover:text-emerald-400 focus:outline-none">
                            <span class="sr-only">Close</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>

                    <div class="px-4 py-5 sm:p-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <!-- Filters -->
						<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-4">
							<!-- TAMBAHAN: Filter Mapel -->
							<select id="filter-mapel" class="filter-select bg-white dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 text-gray-700 dark:text-emerald-100 text-xs rounded-lg block w-full p-2.5 outline-none"><option value="">Semua Mapel</option></select>

							<select id="filter-tipe" class="filter-select bg-white dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 text-gray-700 dark:text-emerald-100 text-xs rounded-lg block w-full p-2.5 outline-none"><option value="">Semua Tipe</option></select>
							<select id="filter-kelas" class="filter-select bg-white dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 text-gray-700 dark:text-emerald-100 text-xs rounded-lg block w-full p-2.5 outline-none"><option value="">Semua Kelas</option></select>
							<select id="filter-kesulitan" class="filter-select bg-white dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 text-gray-700 dark:text-emerald-100 text-xs rounded-lg block w-full p-2.5 outline-none"><option value="">Semua Level</option></select>
							<select id="filter-bab" class="filter-select bg-white dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 text-gray-700 dark:text-emerald-100 text-xs rounded-lg block w-full p-2.5 outline-none"><option value="">Semua BAB</option></select>
							<select id="filter-subbab" class="filter-select bg-white dark:bg-cyber-900 border border-gray-200 dark:border-emerald-800 text-gray-700 dark:text-emerald-100 text-xs rounded-lg block w-full p-2.5 outline-none"><option value="">Semua Sub</option></select>
						</div>                        
                        <button id="search-firebase-btn" class="btn-glow w-full bg-indigo-500 dark:bg-emerald-700 hover:bg-indigo-600 dark:hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all flex items-center justify-center gap-2 border border-transparent dark:border-emerald-500">Cari Soal</button>
                        <div id="total-soal-display" class="text-xs font-bold text-gray-500 dark:text-emerald-400 mt-3 text-right border-b border-gray-200 dark:border-emerald-900 pb-1 hidden">
							Total Soal: <span id="count-value">0</span>
						</div>
                        <div id="bank-soal-list-container" class="mt-6 space-y-3 min-h-[200px]">
                             <div class="text-center text-gray-400 dark:text-emerald-500/40 py-10 flex flex-col items-center">
                                 <span class="text-sm">Silakan cari soal terlebih dahulu</span>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PREVIEW ITEM -->
    <div id="previewItemModal" class="modal fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/60 dark:bg-black/80 backdrop-blur-sm transition-opacity"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto flex items-center justify-center p-4">
             <div class="modal-content bg-white dark:bg-cyber-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-emerald-900 w-full max-w-3xl p-6 relative max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-emerald-800 pb-2">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-emerald-50">Preview Soal</h3>
                    <button onclick="document.getElementById('previewItemModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-white text-2xl">&times;</button>
                </div>
                <div id="preview-item-content" class="overflow-y-auto custom-scrollbar p-2 text-gray-700 dark:text-gray-300"></div>
                <div class="mt-4 text-right pt-2 border-t border-gray-100 dark:border-emerald-800">
                    <button onclick="document.getElementById('previewItemModal').classList.add('hidden')" class="bg-gray-200 dark:bg-emerald-900/30 text-gray-700 dark:text-emerald-100 px-4 py-2 rounded-lg font-bold hover:bg-gray-300 dark:hover:bg-emerald-800 transition-colors">Tutup</button>
                </div>
             </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, deleteDoc, updateDoc, onSnapshot, query, where, getDocs, setLogLevel, runTransaction, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, userId, appId;
        let currentEditingSoalId = null;
        let bankSoalCollectionRef = null;
        let tempBankSoalResults = [];
        let lastFocusedElement = null;
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        let notificationTimeout;

        function showNotification(message, isError = false) {
            clearTimeout(notificationTimeout);
            notificationMessage.textContent = message;
            if (isError) {
                notificationToast.classList.remove('bg-white', 'text-green-700', 'border-green-500');
                notificationToast.classList.add('bg-red-50', 'text-red-700', 'border-red-500');
            } else {
                notificationToast.classList.remove('bg-red-50', 'text-red-700', 'border-red-500');
                notificationToast.classList.add('bg-white', 'text-green-700', 'border-green-500');
            }
            notificationToast.classList.remove('translate-x-[150%]');
            notificationTimeout = setTimeout(() => { notificationToast.classList.add('translate-x-[150%]'); }, 3000);
        }

        const firebaseConfig = {
            apiKey: "AIzaSyAwIwimlyrE4qQqYa2gA8Pfygd59USsveQ",
            authDomain: "aplikasi-ulangan-01.firebaseapp.com",
            projectId: "aplikasi-ulangan-01",
            storageBucket: "aplikasi-ulangan-01.firebasestorage.app",
            messagingSenderId: "409085062439",
            appId: "1:409085062439:web:280589d1a3e12e7b980d02",
        };
        appId = window.__app_id || firebaseConfig.projectId || 'default-app-id';

        // EXPOSE FUNCTION GLOBALLY
        window.execCmd = (command, value = null) => {
            document.execCommand(command, false, value);
            const visualEditor = document.getElementById('question-text-visual');
            visualEditor.focus();
            const event = new Event('input', { bubbles: true });
            visualEditor.dispatchEvent(event);
        };

		

// --- AI GENERATION LOGIC (IMPROVED: READS 2 BLOCKS, IMAGE & SMART API KEY) ---
        window.generateAIExplanation = async () => {
            // SISTEM API KEY OTOMATIS:
            // Aplikasi akan mengecek apakah sudah ada kunci di memori browser.
            // Jika belum ada, aplikasi akan memunculkan kotak input (prompt).
            let API_KEY = localStorage.getItem('gemini_api_key_soal'); 

            if (!API_KEY || API_KEY.length < 10) {
                const inputKey = prompt("Masukkan Google Gemini API Key Anda:\n(Kunci akan disimpan di browser ini agar Anda tidak perlu memasukkannya lagi)");
                if (inputKey && inputKey.length > 10) {
                    localStorage.setItem('gemini_api_key_soal', inputKey);
                    API_KEY = inputKey;
                } else {
                    alert("API Key diperlukan untuk menjalankan fitur ini.");
                    return;
                }
            }

            // 1. Ambil Teks dari BLOK ATAS dan BLOK BAWAH
            const naskahAtas = document.getElementById('question-text-visual').innerText.trim();
            const naskahBawah = document.getElementById('question-text-bottom').innerText.trim();
            
            // 2. Ambil Data Gambar (Base64)
            const naskahImageBase64 = document.getElementById('naskah-image-base64').value;
            
            const type = document.getElementById('question-type').value;
            const bab = document.getElementById('meta-bab').value || 'Umum';
            const level = document.getElementById('meta-kesulitan').value || 'Umum';
            
            if ((!naskahAtas && !naskahBawah) || (naskahAtas.length + naskahBawah.length < 5)) {
                alert("Mohon isi naskah soal (Atas atau Bawah) agar AI bisa menganalisisnya.");
                return;
            }

            // 3. Kumpulkan Opsi Jawaban sesuai Tipe
            let optionsText = "";
            let keyInfo = "Analisis soal ini dan tentukan jawaban yang paling tepat.";

            if (type === 'pg') {
                const textAreas = document.querySelectorAll(`#options-pg textarea`);
                textAreas.forEach((area, index) => optionsText += `\nOpsi ${String.fromCharCode(65 + index)}: ${area.value}`);
                const checked = document.querySelector('input[name="pg-correct"]:checked');
                if (checked) {
                    const index = Array.from(document.querySelectorAll('input[name="pg-correct"]')).indexOf(checked);
                    keyInfo = `Kunci jawaban benar adalah Opsi ${String.fromCharCode(65 + index)}. Jelaskan mengapa benar.`;
                }
            } else if (type === 'pgk') {
                const textAreas = document.querySelectorAll(`#options-pgk textarea`);
                const checkboxes = document.querySelectorAll(`#options-pgk input[type="checkbox"]`);
                let keys = [];
                textAreas.forEach((area, index) => {
                    optionsText += `\nOpsi ${String.fromCharCode(65 + index)}: ${area.value}`;
                    if (checkboxes[index]?.checked) keys.push(String.fromCharCode(65 + index));
                });
                if (keys.length > 0) keyInfo = `Kunci jawaban benar adalah Opsi ${keys.join(', ')}.`;
            } else if (type === 'bs') {
                const textAreas = document.querySelectorAll(`#options-bs textarea`);
                const selects = document.querySelectorAll(`#options-bs select`);
                textAreas.forEach((area, index) => {
                    const status = selects[index].value === 'true' ? 'BENAR' : 'SALAH';
                    optionsText += `\nPernyataan ${index + 1}: ${area.value} (Kunci: ${status})`;
                });
                keyInfo = "Berikan penjelasan analisis untuk setiap pernyataan Benar/Salah tersebut.";
            } else if (type === 'esai-singkat') {
                const key = document.getElementById('kunci-jawaban-singkat').value;
                if(key) keyInfo = `Kunci jawaban diharapkan: "${key}".`;
            }

            // 4. Susun Prompt (Menggabungkan 2 Blok)
            const promptText = `
                Peran: Guru Ahli. Tugas: Buat pembahasan soal yang edukatif dan logis.
                
                Naskah Soal Bagian Atas: "${naskahAtas}"
                Naskah Soal Bagian Bawah: "${naskahBawah}"
                
                Opsi/Pernyataan:
                ${optionsText}
                
                Konteks: Materi ${bab}, Level ${level}.
                Instruksi: ${keyInfo}
                PENTING: Gunakan format LaTeX $...$ untuk rumus matematika. Jangan pakai markdown berlebihan.
            `;

            // 5. Siapkan Payload (Mendukung Gambar/Multimodal)
            const parts = [{ text: promptText }];
            
            if (naskahImageBase64 && naskahImageBase64.startsWith('data:image')) {
                const base64Data = naskahImageBase64.split(',')[1];
                const mimeType = naskahImageBase64.split(';')[0].split(':')[1];
                parts.push({
                    inlineData: {
                        mimeType: mimeType,
                        data: base64Data
                    }
                });
            }

            // UI Loading
            const loading = document.getElementById('ai-loading-indicator');
            const textArea = document.getElementById('pembahasan-editor');
            const btnAI = document.getElementById('btn-ai-generate');
            
            loading.classList.remove('hidden');
            loading.innerText = "âœ¨ AI sedang menganalisis teks & gambar...";
            btnAI.disabled = true;
            textArea.value = "";

            try {
                // Gunakan model gemini-2.5-flash-preview-09-2025 yang mendukung multimodal (teks+gambar)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });

                const data = await response.json();
                
                // Jika API KEY salah/mati, hapus dari memori agar user diminta memasukkan yang baru lagi nanti
                if (response.status === 400 || response.status === 403) {
                    localStorage.removeItem('gemini_api_key_soal');
                    throw new Error("API Key tidak valid atau telah kedaluwarsa. Silakan klik lagi tombol AI untuk memasukkan kunci yang baru.");
                }

                if (!response.ok) throw new Error(data.error?.message || "Gagal menghubungi AI");

                const aiText = data.candidates[0].content.parts[0].text;
                
                // Efek Typewriter
                let i = 0;
                function typeWriter() {
                    if (i < aiText.length) {
                        textArea.value += aiText.charAt(i);
                        textArea.scrollTop = textArea.scrollHeight;
                        i++;
                        setTimeout(typeWriter, 5);
                    } else {
                        loading.classList.add('hidden');
                        btnAI.disabled = false;
                        showNotification("Pembahasan selesai dibuat!");
                        textArea.dispatchEvent(new Event('input'));
                        document.getElementById('pembahasan-toggle').checked = true;
                        document.getElementById('pembahasan-container').style.display = 'block';
                    }
                }
                typeWriter();

            } catch (error) {
                loading.innerText = "âŒ Error: " + error.message;
                btnAI.disabled = false;
                alert("Masalah AI: " + error.message);
            }
        };        
		
		// --- 2. FUNGSI PINDAI TEKS OTOMATIS (DUA MODE: SOAL SAJA / + KUNCI) ---
        window.scanQuestionAI = async () => {
            let API_KEY = localStorage.getItem('gemini_api_key_soal');
            const naskahImageBase64 = document.getElementById('naskah-image-base64').value;
            const btnScan = document.getElementById('btn-scan-ocr');
            const scanMode = document.getElementById('scan-mode').value;
            
            if (!naskahImageBase64) { 
                alert("Silakan unggah gambar/PDF soal terlebih dahulu."); 
                return; 
            }
            if (!API_KEY) { 
                const k = prompt("Masukkan API Key:"); 
                if(k) { localStorage.setItem('gemini_api_key_soal', k); API_KEY = k; } 
                else return; 
            }

            const originalText = btnScan.innerHTML;
            btnScan.innerHTML = "âŒ› Menganalisis...";
            btnScan.disabled = true;

            try {
                // Instruksi Kunci yang lebih ketat
                let instruksiKunci = "";
                if (scanMode === 'dengan_kunci') {
                    instruksiKunci = "Tentukan kunci jawaban dengan teliti. Untuk tipe 'bs', bandingkan setiap pernyataan dengan fakta di naskah. JANGAN menganggap semua benar. Hasil kunci BS harus berupa array string ['true', 'false', ...].";
                } else {
                    instruksiKunci = "Hanya salin naskah dan opsi. JANGAN menebak kunci jawaban (set kunci ke null).";
                }

                const promptOCR = `Analisis gambar soal ini (hasil crop).
                
                ATURAN KLASIFIKASI:
                1. Jika terdapat daftar pernyataan yang menuntut verifikasi (Benar/Salah, Sesuai/Tidak Sesuai, Ya/Tidak), klasifikasikan sebagai tipe "bs".
                2. Jika terdapat pilihan A, B, C, D dengan kotak centang, klasifikasikan sebagai "pgk".
                
                TUGAS KHUSUS:
                - ${instruksiKunci}
                - Gunakan simbol $...$ untuk semua rumus/variabel matematika LaTeX.
                
                Format JSON:
                { 
                  "naskah": "isi teks soal utama", 
                  "tipe": "pg" atau "pgk" atau "bs" atau "esai-singkat", 
                  "opsi": ["pernyataan/opsi 1", "pernyataan/opsi 2", ...], 
                  "kunci": index_angka (pg), array_index (pgk), atau array_string ["true", "false"] (bs) 
                }`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [
                                { text: promptOCR }, 
                                { inlineData: { 
                                    mimeType: naskahImageBase64.split(';')[0].split(':')[1], 
                                    data: naskahImageBase64.split(',')[1] 
                                } }
                            ] 
                        }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || "Gagal menghubungi AI");
                
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                
                // 1. Isi Naskah
                document.getElementById('question-text-visual').innerHTML = result.naskah.replace(/\n/g, '<br>');
                
                // 2. Set Tipe
                const typeSelector = document.getElementById('question-type');
                typeSelector.value = result.tipe;
                typeSelector.dispatchEvent(new Event('change'));

                // 3. Isi Opsi & Kunci
                setTimeout(() => {
                    const pgList = document.getElementById('options-pg-list');
                    const pgkList = document.getElementById('options-pgk-list');
                    const bsList = document.getElementById('options-bs-list');
                    if(pgList) pgList.innerHTML = '';
                    if(pgkList) pgkList.innerHTML = '';
                    if(bsList) bsList.innerHTML = '';

                    if (result.tipe === 'pg' && result.opsi) {
                        result.opsi.forEach((o, idx) => {
                            const isCorrect = (scanMode === 'dengan_kunci' && result.kunci === idx);
                            window.createPgOption(idx === 0, o, isCorrect);
                        });
                    } else if (result.tipe === 'pgk' && result.opsi) {
                        result.opsi.forEach((o, idx) => {
                            const isCorrect = (scanMode === 'dengan_kunci' && Array.isArray(result.kunci) && result.kunci.includes(idx));
                            window.createPgkOption(o, isCorrect);
                        });
                    } else if (result.tipe === 'bs' && result.opsi) {
                        result.opsi.forEach((o, idx) => {
                            // Default ke 'true' jika mode 'hanya soal', atau ambil hasil analisis AI jika '+kunci'
                            let keyVal = 'true';
                            if (scanMode === 'dengan_kunci' && Array.isArray(result.kunci)) {
                                keyVal = String(result.kunci[idx] || 'true');
                            }
                            window.createBsStatement(o, keyVal);
                        });
                    }
                    document.getElementById('question-text-visual').dispatchEvent(new Event('input', { bubbles: true }));
                    if(window.MathJax) window.MathJax.typesetPromise();
                }, 500);

                showNotification(`Berhasil memindai soal ${result.tipe.toUpperCase()}`);

            } catch (error) { 
                console.error(error);
                alert("Gagal memproses soal: " + error.message); 
            } finally { 
                btnScan.innerHTML = originalText; 
                btnScan.disabled = false; 
            }
        };

        // Pasang listener klik
        document.getElementById('btn-scan-ocr').addEventListener('click', window.scanQuestionAI);
		// --- Helper for Static Preview ---
        window.generateStaticPreview = (d) => {
            let html = `<div class="space-y-4">`;
            
            // Render Metadata (UPDATE SERAGAM: Tipe, Level, Bab, Subbab)
            // Hapus Mapel & Kelas, Ganti dengan Tipe & Subbab
            html += `<div class="flex flex-wrap gap-2 mb-4">
                <span class="badge bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold border border-blue-200">${(d.type || '?').toUpperCase()}</span>
                <span class="badge bg-pink-100 text-pink-800 px-2 py-1 rounded text-xs font-bold border border-pink-200">${d.metadata?.kesulitan || 'Level'}</span>
                <span class="badge bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs font-bold border border-gray-200">${d.metadata?.bab || 'Bab'}</span>
                <span class="badge bg-teal-100 text-teal-800 px-2 py-1 rounded text-xs font-bold border border-teal-200">${d.metadata?.subbab || 'Sub'}</span>
            </div>`;

            // Teks Atas
            html += `<div class="text-lg text-gray-800 dark:text-white leading-relaxed mb-4">${d.naskah}</div>`;

            // Gambar Tengah
            if (d.naskahImage) {
                html += `<div class="flex justify-center mb-4"><img src="${d.naskahImage}" class="max-h-64 rounded-lg border border-gray-200 shadow-sm"></div>`;
            }

            // Teks Bawah
            if (d.naskahBawah) {
                html += `<div class="text-lg text-gray-800 dark:text-white leading-relaxed mb-4">${d.naskahBawah}</div>`;
            }

            // RENDER OPSI & KUNCI
            if (d.type === 'pg') {
                html += `<div class="space-y-2">`;
                d.opsi.forEach((o, i) => {
                    const letter = String.fromCharCode(65 + i);
                    // Perbaikan: Cek kunci dari properti d.kunci (bukan o.isCorrect)
                    const isKey = d.kunci == i; // Gunakan loose equality (==) untuk aman angka vs string
                    const keyStyle = isKey ? 'bg-green-100 border-green-500 text-green-800 font-bold ring-2 ring-green-400' : 'bg-gray-50 border-gray-200 text-gray-600';
                    html += `<div class="flex items-start gap-3 p-2 border rounded-lg ${keyStyle}">
                        <div class="w-8 h-8 flex items-center justify-center rounded bg-white border text-sm font-bold">${letter}</div>
                        <div class="flex-1">
                            <div>${o.text} ${isKey ? 'âœ… (Kunci)' : ''}</div>
                            ${o.imageBase64 ? `<img src="${o.imageBase64}" class="h-16 mt-1 rounded">` : ''}
                        </div>
                    </div>`;
                });
                html += `</div>`;
            } else if (d.type === 'pgk') {
                html += `<div class="space-y-2">`;
                d.opsi.forEach((o, i) => {
                    // Perbaikan: Cek array kunci
                    const isKey = Array.isArray(d.kunci) && d.kunci.includes(i);
                    const keyStyle = isKey ? 'bg-green-100 border-green-500' : 'bg-gray-50 border-gray-200';
                    html += `<div class="flex items-start gap-3 p-2 border rounded-lg ${keyStyle}">
                        <div class="w-5 h-5 mt-1 border-2 rounded ${isKey ? 'bg-green-500 border-green-500' : 'bg-white'}"></div>
                        <div class="flex-1">
                            <div>${o.text} ${isKey ? 'âœ…' : ''}</div>
                            ${o.imageBase64 ? `<img src="${o.imageBase64}" class="h-16 mt-1 rounded">` : ''}
                        </div>
                    </div>`;
                });
                html += `</div>`;
            } else if (d.type === 'bs') {
                html += `<div class="border rounded-lg overflow-hidden"><table class="w-full text-sm text-left">
                    <thead class="bg-gray-100"><tr><th class="p-2">Pernyataan</th><th class="p-2 text-center">Kunci</th></tr></thead>
                    <tbody>`;
                d.opsi.forEach((o, i) => {
                    // BS kuncinya array ['true', 'false', ...]
                    let keyText = "-";
                    if(d.kunci && d.kunci[i]) {
                        keyText = (d.kunci[i] === 'true' || d.kunci[i] === true) ? '<span class="text-green-600 font-bold">BENAR</span>' : '<span class="text-red-500 font-bold">SALAH</span>';
                    }
                    html += `<tr class="border-t"><td class="p-2">${o.text}</td><td class="p-2 text-center">${keyText}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            } else if (d.type === 'esai-singkat') {
                // Perbaikan: Tampilkan kunci langsung
                html += `<div class="p-4 bg-green-50 border border-green-200 rounded text-green-800 font-bold mt-2">
                    ðŸ”‘ KUNCI JAWABAN: ${d.kunci || 'Belum diatur'}
                </div>`;
            } else {
                html += `<div class="p-3 bg-yellow-50 border border-yellow-200 rounded text-yellow-800 font-mono">Penilaian Manual (Esai Uraian)</div>`;
            }

            // Pembahasan
            if (d.pembahasan) {
                html += `
                <div class="mt-4 p-3 bg-indigo-50 dark:bg-cyber-900/50 border-l-4 border-indigo-400 dark:border-indigo-600 rounded-r text-sm">
                    <div class="font-bold text-indigo-800 dark:text-indigo-300 text-xs uppercase mb-1">Pembahasan</div>
                    <div class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap leading-relaxed">${d.pembahasan}</div>
                    ${d.pembahasanImage ? `<img src="${d.pembahasanImage}" class="max-h-32 mt-2 rounded border border-gray-300 dark:border-gray-600">` : ''}
                </div>`;
            }

            html += `</div>`;
            return html;
        };

        // Math Symbols List
        const mathSymbols = [
            'Î±', 'Î²', 'Î³', 'Î´', 'Î¸', 'Î»', 'Ï€', 'Ï', 'Ïƒ', 'Ï†', 'Ï‰', 'Î”', 'Î£', 'Î©', 
            'Â°', 'âˆ ', 'âŠ¥', 'âˆ¥', 'â‰ˆ', 'â‰ ', 'â‰¤', 'â‰¥', 'Â±', 'Ã—', 'Ã·', 'âˆš', 'âˆž', 
            'Â½', 'â…“', 'Â¼', 'Â¾', 'â†', 'â†‘', 'â†’', 'â†“', 'â†”'
        ];

        window.toggleMathKeyboard = () => {
            const kb = document.getElementById('math-keyboard');
            if (kb.style.display === 'grid') {
                kb.style.display = 'none';
            } else {
                kb.style.display = 'grid';
                if(kb.children.length === 0) {
                    mathSymbols.forEach(sym => {
                        const btn = document.createElement('button');
                        btn.className = 'math-key';
                        btn.textContent = sym;
                        btn.onclick = (e) => {
                            e.preventDefault(); // Prevent button from stealing focus completely
                            insertSymbol(sym);
                        };
                        kb.appendChild(btn);
                    });
                }
            }
        };

        function insertSymbol(symbol) {
            if (!lastFocusedElement) {
                lastFocusedElement = document.getElementById('question-text-visual');
            }
            lastFocusedElement.focus();
            if (lastFocusedElement.isContentEditable) {
                document.execCommand('insertText', false, symbol);
            } else {
                const start = lastFocusedElement.selectionStart;
                const end = lastFocusedElement.selectionEnd;
                const text = lastFocusedElement.value;
                lastFocusedElement.value = text.substring(0, start) + symbol + text.substring(end);
                lastFocusedElement.selectionStart = lastFocusedElement.selectionEnd = start + symbol.length;
                const event = new Event('input', { bubbles: true });
                lastFocusedElement.dispatchEvent(event);
            }
        }

        document.addEventListener('focusin', (e) => {
            if (e.target.isContentEditable || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
                lastFocusedElement = e.target;
            }
        });
        
        window.handleOptionPaste = async (e, uniqueId) => {
             const items = (e.clipboardData || e.originalEvent.clipboardData).items;
             let blob = null;
             for (const item of items) {
                 if (item.type.indexOf("image") === 0) {
                     blob = item.getAsFile();
                     break;
                 }
             }
             if (blob) {
                 e.preventDefault(); 
                 showNotification("Memproses gambar clipboard...", false);
                 
                 const reader = new FileReader();
                 reader.onload = (event) => {
                     const img = new Image();
                     img.src = event.target.result;
                     img.onload = () => {
                         const canvas = document.createElement('canvas');
                         let width = img.width; let height = img.height;
                         const maxWidth = 800;
                         if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                         canvas.width = width; canvas.height = height;
                         const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                         const compressedBase64 = canvas.toDataURL('image/jpeg', 0.6);
                         
                         const base64Input = document.getElementById(`base64-${uniqueId}`);
                         const previewContainer = document.getElementById(`preview-container-${uniqueId}`);
                         const previewImg = document.getElementById(`preview-${uniqueId}`);
                         
                         if(base64Input && previewContainer && previewImg) {
                             base64Input.value = compressedBase64;
                             previewImg.src = compressedBase64;
                             previewContainer.style.display = "inline-block";
                             previewContainer.classList.remove("hidden");
                             
                             const textInput = document.querySelector(`textarea[oninput*='${uniqueId}']`) || e.target;
                             textInput.dispatchEvent(new Event('input', { bubbles: true }));
                             showNotification("Gambar berhasil ditempel ke opsi!");
                         }
                     };
                 };
                 reader.readAsDataURL(blob);
             }
        };

        document.addEventListener('DOMContentLoaded', async () => {
			// --- SISIPKAN KODE INI ---
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            bankSoalCollectionRef = collection(db, 'bank_soal');
            // -------------------------
            const compressImage = (base64Str, maxWidth = 800, quality = 0.6) => {
                return new Promise((resolve) => {
                    const img = new Image(); img.src = base64Str;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width; let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = (err) => resolve(base64Str);
                });
            };

            const questionType = document.getElementById('question-type');
            const editorContainer = document.getElementById('editor-container');
            const editorLivePreview = document.getElementById('editor-live-preview');
            
			const editorVisual = document.getElementById('question-text-visual');
			const editorBottom = document.getElementById('question-text-bottom'); // <-- TAMBAHKAN INI

            function updateLivePreview() {
                editorLivePreview.innerHTML = renderLivePreviewHtml();
                if (window.MathJax && window.MathJax.typesetPromise) { MathJax.typesetPromise([editorLivePreview]).catch((err) => console.log(err.message)); }
            }

            editorVisual.addEventListener('input', updateLivePreview);
			editorBottom.addEventListener('input', updateLivePreview); // TAMBAHAN BARU

            const metaKelas = document.getElementById('meta-kelas');
            const metaKesulitan = document.getElementById('meta-kesulitan');
			const metaMapel = document.getElementById('meta-mapel'); // TAMBAHAN
			const mapelList = document.getElementById('mapel-list'); // TAMBAHAN
            
            const metaBabInput = document.getElementById('meta-bab');
            const metaSubbabInput = document.getElementById('meta-subbab');
            const babList = document.getElementById('bab-list');
            const subbabList = document.getElementById('subbab-list');
            let metadataMap = {}; 
            
            const optionContainers = document.querySelectorAll('.options-container');
            const optionsPg = document.getElementById('options-pg');
            const optionsPgk = document.getElementById('options-pgk');
            const optionsBs = document.getElementById('options-bs');
            const optionsEsaiSingkat = document.getElementById('options-esai-singkat');
            const optionsEsaiKompleks = document.getElementById('options-esai-kompleks');
            
            const pgList = document.getElementById('options-pg-list');
            const pgkList = document.getElementById('options-pgk-list');
            const bsList = document.getElementById('options-bs-list');
            const kunciJawabanSingkat = document.getElementById('kunci-jawaban-singkat');
            
            const addPgOptionBtn = document.getElementById('add-pg-option');
            const addPgkOptionBtn = document.getElementById('add-pgk-option');
            const addBsStatementBtn = document.getElementById('add-bs-statement');

            const pembahasanToggle = document.getElementById('pembahasan-toggle');
            const pembahasanContainer = document.getElementById('pembahasan-container');
            const pembahasanEditor = document.getElementById('pembahasan-editor');
            const pembahasanImageInput = document.getElementById('pembahasan-image-input');
            const pembahasanImageBase64 = document.getElementById('pembahasan-image-base64');
            const pembahasanImagePreview = document.getElementById('pembahasan-image-preview');
            
            const naskahImageInput = document.getElementById('naskah-image-input');
            const naskahImageBase64 = document.getElementById('naskah-image-base64');
            const naskahImagePreview = document.getElementById('naskah-image-preview');

            const saveBankSoalBtn = document.getElementById('save-bank-soal-btn');
            const editModeIdInput = document.getElementById('edit-mode-id');
            const clearEditorBtn = document.getElementById('clear-editor-btn');
            
            const bankSoalModal = document.getElementById('bankSoalModal');
            const openBankSoalBtn = document.getElementById('open-bank-soal-btn');
            const closeBankSoalModalBtn = document.getElementById('close-bank-soal-modal-btn');
            const searchFirebaseBtn = document.getElementById('search-firebase-btn');
            const bankSoalListContainer = document.getElementById('bank-soal-list-container');
            const importJsonInput = document.getElementById('import-json-input'); 
            
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');

            // --- AI & Pembahasan Logic ---
            document.getElementById('btn-ai-generate').addEventListener('click', generateAIExplanation);

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
				bankSoalCollectionRef = collection(db, 'bank_soal');
                auth = getAuth(app);
                showNotification("Menghubungkan sistem...");
                // --- LOGIKA KEAMANAN BARU (REPLACE) ---
            
            // Cek status login
            onAuthStateChanged(auth, (user) => {
                const loginOverlay = document.getElementById('login-overlay');
                const logoutBtn = document.getElementById('logout-btn');
                
                // Cek apakah login pakai Password (Bukan Anonymous)
                const isGuru = user && user.providerData.some(p => p.providerId === 'password');

                if (isGuru) {
                    // Berhasil Login sebagai Guru
                    userId = user.uid;
                    loginOverlay.classList.add('hidden'); // Sembunyikan layar login
                    if(logoutBtn) logoutBtn.classList.remove('hidden');
                    
                    showNotification('Selamat datang, Admin.');
                    
                    // Panggil fungsi inisialisasi data (pastikan nama fungsi ini ada di kode lama Anda)
                    if (typeof loadExistingMetadataOptions === 'function') loadExistingMetadataOptions();
                    
                } else {
                    // Belum Login / Masih Anonymous -> Tampilkan Layar Login
                    loginOverlay.classList.remove('hidden');
                    if(logoutBtn) logoutBtn.classList.add('hidden');
                    
                    // Jika login sebagai anonymous (siswa), paksa keluar agar tidak nyangkut
                    if (user && !isGuru) signOut(auth);
                }
            });

            // Event Listener Form Login
            const loginForm = document.getElementById('admin-login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('admin-email').value;
                    const pass = document.getElementById('admin-password').value;
                    const errorMsg = document.getElementById('login-error-msg');
                    const btn = loginForm.querySelector('button');

                    btn.textContent = "Memproses...";
                    btn.disabled = true;
                    errorMsg.classList.add('hidden');

                    try {
                        await signInWithEmailAndPassword(auth, email, pass);
                        // onAuthStateChanged akan otomatis jalan setelah ini
                    } catch (error) {
                        console.error(error);
                        btn.textContent = "Masuk Sistem";
                        btn.disabled = false;
                        errorMsg.textContent = "Gagal: Email/Password Salah!";
                        errorMsg.classList.remove('hidden');
                    }
                });
            }

            // Event Listener Logout
            const btnLogout = document.getElementById('logout-btn');
            if (btnLogout) {
                btnLogout.addEventListener('click', () => {
                    if(confirm("Keluar dari akun admin?")) signOut(auth);
                });
            }
            // --- AKHIR LOGIKA KEAMANAN ---
            } catch (error) {
                showNotification(`Koneksi Gagal: ${error.message}`, true);
                saveBankSoalBtn.disabled = true;
            }

            function setDarkMode(isDark) {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    moonIcon.classList.remove('hidden');
                    sunIcon.classList.add('hidden');
                    localStorage.setItem('theme', 'light');
                }
            }
            darkModeToggle.addEventListener('click', () => { setDarkMode(!document.documentElement.classList.contains('dark')); });
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');
            setDarkMode(savedTheme === 'dark' || (!savedTheme && prefersDark));

            // --- TOOLBAR COMMANDS ---
            window.execCmd = (command, value = null) => {
                document.execCommand(command, false, value);
                editorVisual.focus();
                // Trigger input event for live preview
                const event = new Event('input', { bubbles: true });
                editorVisual.dispatchEvent(event);
            };
			
						// FUNGSI MEMBUAT TABEL SEDERHANA
			window.insertTable = () => {
				// 1. Tentukan target editor (Atas atau Bawah) berdasarkan fokus terakhir
				let targetEditor = lastFocusedElement;

				// Jika fokus bukan di editor teks (misal di input judul), paksa ke editor atas
				if (!targetEditor || (targetEditor.id !== 'question-text-visual' && targetEditor.id !== 'question-text-bottom')) {
					targetEditor = document.getElementById('question-text-visual');
				}

				// 2. Minta input baris & kolom
				const rows = prompt("Masukkan jumlah BARIS (contoh: 3):", "2");
				if (!rows || isNaN(rows)) return;

				const cols = prompt("Masukkan jumlah KOLOM (contoh: 4):", "2");
				if (!cols || isNaN(cols)) return;

				// 3. Generate HTML Tabel
				let tableHtml = '<table class="generated-table"><tbody>';

				// Header (Baris pertama dianggap header agar tebal)
				tableHtml += '<tr>';
				for (let j = 0; j < cols; j++) {
					tableHtml += `<th>Judul ${j+1}</th>`;
				}
				tableHtml += '</tr>';

				// Baris Data
				for (let i = 1; i < rows; i++) {
					tableHtml += '<tr>';
					for (let j = 0; j < cols; j++) {
						tableHtml += '<td>...</td>';
					}
					tableHtml += '</tr>';
				}
				tableHtml += '</tbody></table><p>&nbsp;</p>'; // Tambah spasi di bawah tabel

				// 4. Sisipkan ke posisi kursor
				targetEditor.focus();
				// Cek apakah browser mendukung insertHTML (standar modern)
				if (document.queryCommandSupported('insertHTML')) {
					document.execCommand('insertHTML', false, tableHtml);
				} else {
					// Fallback sederhana (append ke bawah)
					targetEditor.innerHTML += tableHtml;
				}

				// 5. Trigger update preview
				targetEditor.dispatchEvent(new Event('input', { bubbles: true }));
			};
            
            async function loadExistingMetadataOptions() {
				if (!bankSoalCollectionRef) return;
				try {
					const snapshot = await getDocs(query(bankSoalCollectionRef));
					metadataMap = {};
					const mapelSet = new Set(); // TAMBAHAN

					snapshot.forEach(docSnap => {
						const d = docSnap.data();
						// TAMBAHAN: Ambil Mapel
						if(d.metadata?.mapel) mapelSet.add(d.metadata.mapel);

						const bab = d.metadata?.bab;
						const sub = d.metadata?.subbab;
						if(bab) {
							if(!metadataMap[bab]) metadataMap[bab] = new Set();
							if(sub) metadataMap[bab].add(sub);
						}
					});

					// Populate Datalist Mapel
					mapelList.innerHTML = '';
					mapelSet.forEach(m => {
						const opt = document.createElement('option');
						opt.value = m; mapelList.appendChild(opt);
					});

					// Populate Datalist BAB (Existing code)
					babList.innerHTML = '';
					Object.keys(metadataMap).sort().forEach(bab => {
						const opt = document.createElement('option');
						opt.value = bab; babList.appendChild(opt);
					});
				} catch (e) { console.error("Gagal memuat metadata:", e); }
			}

            metaBabInput.addEventListener('input', function() {
                const selectedBab = this.value; subbabList.innerHTML = ''; 
                if (metadataMap[selectedBab]) {
                    metadataMap[selectedBab].forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub; subbabList.appendChild(opt);
                    });
                }
            });

            window.createPgOption = (isFirst = false, text = '', isCorrect = false, imageBase64 = '') => {
                const uniqueId = `opt-${Date.now()}-${Math.random()}`;
                const div = document.createElement('div');
                div.className = 'group flex items-start gap-3 bg-gray-50 dark:bg-cyber-900 p-3 rounded-xl border border-gray-100 dark:border-emerald-800 hover:border-indigo-300 dark:hover:border-emerald-500 transition-all';
                div.innerHTML = `
                    <div class="pt-2"><input type="radio" name="pg-correct" class="w-5 h-5 text-indigo-600" ${isCorrect || (isFirst && !isCorrect) ? 'checked' : ''}></div>
                    <div class="flex-1 min-w-0">
                        <textarea id="text-${uniqueId}" rows="2" class="w-full bg-white dark:bg-cyber-800 border border-gray-200 dark:border-emerald-700 rounded-lg p-2 text-sm dark:text-emerald-50 outline-none resize-none" placeholder="Teks opsi...">${text}</textarea>
                        <div class="mt-2 flex items-center gap-2">
                            <label class="cursor-pointer text-[10px] font-bold text-indigo-500 dark:text-emerald-400">+ Gambar <input type="file" id="file-${uniqueId}" class="file-input opsi-file-input hidden" accept="image/*"></label>
                            <button type="button" class="url-btn text-[10px] font-bold text-gray-400 dark:text-emerald-600" data-target-id="${uniqueId}">Link</button>
                            <div id="preview-container-${uniqueId}" class="editor-image-preview-container relative" style="${imageBase64 ? 'display: inline-block;' : 'display: none;'}"><img id="preview-${uniqueId}" src="${imageBase64}" class="h-8 w-8 object-cover rounded border"><button type="button" class="remove-image-btn absolute -top-1 -right-1 bg-rose-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px]" data-target-id="${uniqueId}">&times;</button></div>
                            <input type="hidden" id="base64-${uniqueId}" class="opsi-image-base64" value="${imageBase64}">
                        </div>
                    </div>
                    <button type="button" class="remove-btn text-gray-400 hover:text-rose-500 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
                pgList.appendChild(div);
                
                const textarea = document.getElementById(`text-${uniqueId}`);
                textarea.addEventListener('input', updateLivePreview);
                textarea.addEventListener('paste', (e) => handleOptionPaste(e, uniqueId));
            };

            window.createPgkOption = (text = '', isCorrect = false, imageBase64 = '') => {
                const uniqueId = `opt-${Date.now()}-${Math.random()}`;
                const div = document.createElement('div');
                div.className = 'group flex items-start gap-3 bg-gray-50 dark:bg-cyber-900 p-3 rounded-xl border border-gray-100 dark:border-emerald-800 hover:border-indigo-300 dark:hover:border-emerald-500 transition-all';
                div.innerHTML = `
                    <div class="pt-2"><input type="checkbox" class="w-5 h-5 text-indigo-600" ${isCorrect ? 'checked' : ''}></div>
                    <div class="flex-1 min-w-0">
                        <textarea id="text-${uniqueId}" rows="2" class="w-full bg-white dark:bg-cyber-800 border border-gray-200 dark:border-emerald-700 rounded-lg p-2 text-sm dark:text-emerald-50 outline-none resize-none" placeholder="Teks opsi...">${text}</textarea>
                         <div class="mt-2 flex items-center gap-2">
                            <label class="cursor-pointer text-[10px] font-bold text-indigo-500 dark:text-emerald-400">+ Gambar <input type="file" id="file-${uniqueId}" class="file-input opsi-file-input hidden" accept="image/*"></label>
                            <div id="preview-container-${uniqueId}" class="editor-image-preview-container relative" style="${imageBase64 ? 'display: inline-block;' : 'display: none;'}"><img id="preview-${uniqueId}" src="${imageBase64}" class="h-8 w-8 object-cover rounded border"><button type="button" class="remove-image-btn absolute -top-1 -right-1 bg-rose-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px]" data-target-id="${uniqueId}">&times;</button></div>
                            <input type="hidden" id="base64-${uniqueId}" class="opsi-image-base64" value="${imageBase64}">
                        </div>
                    </div>
                    <button type="button" class="remove-btn text-gray-400 hover:text-rose-500 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
                pgkList.appendChild(div);
                
                const textarea = document.getElementById(`text-${uniqueId}`);
                textarea.addEventListener('input', updateLivePreview);
                textarea.addEventListener('paste', (e) => handleOptionPaste(e, uniqueId));
            };

            window.createBsStatement = (text = '', isCorrect = 'true', imageBase64 = '') => {
                const uniqueId = `opt-${Date.now()}-${Math.random()}`;
                const div = document.createElement('div');
                div.className = 'group flex items-start gap-3 bg-gray-50 dark:bg-cyber-900 p-3 rounded-xl border border-gray-100 dark:border-emerald-800 hover:border-indigo-300 dark:hover:border-emerald-500 transition-all';
                div.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <textarea id="text-${uniqueId}" rows="2" class="w-full bg-white dark:bg-cyber-800 border border-gray-200 dark:border-emerald-700 rounded-lg p-2 text-sm dark:text-emerald-50 outline-none resize-none" placeholder="Pernyataan...">${text}</textarea>
                        <div class="mt-2 flex items-center gap-2">
                             <label class="cursor-pointer text-[10px] font-bold text-indigo-500 dark:text-emerald-400">+ Gambar <input type="file" id="file-${uniqueId}" class="file-input opsi-file-input hidden" accept="image/*"></label>
                            <div id="preview-container-${uniqueId}" class="editor-image-preview-container relative" style="${imageBase64 ? 'display: inline-block;' : 'display: none;'}"><img id="preview-${uniqueId}" src="${imageBase64}" class="h-8 w-8 object-cover rounded border"><button type="button" class="remove-image-btn absolute -top-1 -right-1 bg-rose-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px]" data-target-id="${uniqueId}">&times;</button></div>
                            <input type="hidden" id="base64-${uniqueId}" class="opsi-image-base64" value="${imageBase64}">
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <select class="bg-white dark:bg-cyber-800 border border-gray-200 dark:border-emerald-700 text-gray-700 dark:text-emerald-50 text-sm rounded-lg block p-2">
                            <option value="true" ${isCorrect === 'true' ? 'selected' : ''}>Benar</option>
                            <option value="false" ${isCorrect === 'false' ? 'selected' : ''}>Salah</option>
                        </select>
                        <button type="button" class="remove-btn text-rose-400 hover:text-rose-600 text-xs font-medium text-right">Hapus</button>
                    </div>`;
                bsList.appendChild(div);
                
                const textarea = document.getElementById(`text-${uniqueId}`);
                textarea.addEventListener('input', updateLivePreview);
                textarea.addEventListener('paste', (e) => handleOptionPaste(e, uniqueId));
            };
            
            function handleTypeChange() {
                optionContainers.forEach(container => container.style.display = 'none');
                const type = questionType.value;
                switch(type) {
                    case 'pg': optionsPg.style.display = 'block'; break;
                    case 'pgk': optionsPgk.style.display = 'block'; break;
                    case 'bs': optionsBs.style.display = 'block'; break;
                    case 'esai-singkat': optionsEsaiSingkat.style.display = 'block'; break;
                    case 'esai-kompleks': optionsEsaiKompleks.style.display = 'block'; break;
                }
            }

            function clearImageInput(inputId) {
                let fileInput = document.getElementById(`${inputId}-image-input`);
                let base64Input = document.getElementById(`${inputId}-image-base64`);
                let previewContainer = document.getElementById(`${inputId}-image-preview-container`);
                let previewImg = document.getElementById(`${inputId}-image-preview`);

                if (!fileInput) fileInput = document.getElementById(`file-${inputId}`);
                if (!base64Input) base64Input = document.getElementById(`base64-${inputId}`);
                if (!previewContainer) previewContainer = document.getElementById(`preview-container-${inputId}`);
                if (!previewImg) previewImg = document.getElementById(`preview-${inputId}`);

                if (fileInput) fileInput.value = '';
                if (base64Input) base64Input.value = '';
                if (previewImg) previewImg.src = '';
                if (previewContainer) {
                    previewContainer.classList.add('hidden');
                    previewContainer.style.display = 'none'; 
                }
            }

            function loadImageInput(inputId, base64String) {
                let base64Input = document.getElementById(`${inputId}-image-base64`);
                let previewContainer = document.getElementById(`${inputId}-image-preview-container`);
                let previewImg = document.getElementById(`${inputId}-image-preview`);

                if (!base64Input) base64Input = document.getElementById(`base64-${inputId}`);
                if (!previewContainer) previewContainer = document.getElementById(`preview-container-${inputId}`);
                if (!previewImg) previewImg = document.getElementById(`preview-${inputId}`);

                if (base64String) {
                    if (base64Input) base64Input.value = base64String;
                    if (previewImg) previewImg.src = base64String;
                    if (previewContainer) {
                         previewContainer.classList.remove('hidden');
                         previewContainer.style.display = 'inline-block'; 
                    }
                } else {
                    clearImageInput(inputId);
                }
            }

            function clearEditor() {
                questionType.value = 'pg'; 
                editorVisual.innerHTML = ''; 
				editorBottom.innerHTML = ''; // TAMBAHAN BARU
                
				metaMapel.value = ''; // TAMBAHAN
                metaKelas.value = ''; metaKesulitan.value = 'C1'; metaBabInput.value = ''; metaSubbabInput.value = ''; 
                pgList.innerHTML = ''; pgkList.innerHTML = ''; bsList.innerHTML = ''; kunciJawabanSingkat.value = '';
                pembahasanToggle.checked = false; pembahasanContainer.style.display = 'none'; pembahasanEditor.value = '';
                clearImageInput('naskah'); clearImageInput('pembahasan');
                for (let i = 0; i < 5; i++) createPgOption(i === 0);
                for (let i = 0; i < 3; i++) createPgkOption();
                for (let i = 0; i < 2; i++) createBsStatement();
                handleTypeChange();
                
                currentEditingSoalId = null; 
                editModeIdInput.value = '';
                saveBankSoalBtn.innerHTML = `
                    <span class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        Simpan Aman (Secure)
                    </span>`;
                saveBankSoalBtn.classList.remove('from-yellow-500', 'to-orange-500');
                saveBankSoalBtn.classList.add('from-indigo-500', 'to-purple-500');
                
                // Update tombol batal
                clearEditorBtn.textContent = "Bersihkan";
                clearEditorBtn.classList.remove('bg-rose-100', 'text-rose-600');
                clearEditorBtn.classList.add('bg-gray-200', 'text-gray-700');
                
                updateLivePreview();
            }

            async function populateEditor(soal) {
                clearEditor(); 
                currentEditingSoalId = soal.firebaseId; editModeIdInput.value = soal.firebaseId;
                
                // Gunakan kunci yang sudah diambil dari search (Langkah 2), atau ambil ulang jika null
                let kunciData = soal.kunci;
                if (kunciData === undefined) {
                    try {
                        const keyDoc = await getDoc(doc(db, 'bank_soal_privat', currentEditingSoalId));
                        if(keyDoc.exists()) {
                            kunciData = keyDoc.data().kunci;
                        }
                    } catch(e) { console.log('Gagal ambil kunci fallback', e); }
                }

                saveBankSoalBtn.innerHTML = 'Simpan Perubahan';
                saveBankSoalBtn.classList.remove('from-indigo-500', 'to-purple-500');
                saveBankSoalBtn.classList.add('from-yellow-500', 'to-orange-500');
                
                clearEditorBtn.textContent = "Batal Edit";
                clearEditorBtn.classList.remove('bg-gray-200', 'text-gray-700');
                clearEditorBtn.classList.add('bg-rose-100', 'text-rose-600');

                questionType.value = soal.type; 
                editorVisual.innerHTML = soal.naskah; 
                editorBottom.innerHTML = soal.naskahBawah || ''; 
                
                metaMapel.value = soal.metadata.mapel || ''; 
                metaKelas.value = soal.metadata.kelas || ''; 
                metaKesulitan.value = soal.metadata.kesulitan || 'C1';
                metaBabInput.value = soal.metadata.bab || ''; 
                metaSubbabInput.value = soal.metadata.subbab || '';
                
                loadImageInput('naskah', soal.naskahImage);
                if (soal.pembahasan) {
                    pembahasanToggle.checked = true; pembahasanContainer.style.display = 'block'; pembahasanEditor.value = soal.pembahasan;
                    loadImageInput('pembahasan', soal.pembahasanImage);
                }
                pgList.innerHTML = ''; pgkList.innerHTML = ''; bsList.innerHTML = ''; kunciJawabanSingkat.value = '';
                
                // Restore Options & Keys
                switch(soal.type) {
                    case 'pg': 
                        soal.opsi.forEach((opt, i) => {
                            // Perbaikan: Gunakan loose equality (==) untuk handle angka/string index
                            const isCorrect = (kunciData == i);
                            createPgOption(false, opt.text, isCorrect, opt.imageBase64);
                        }); 
                        break;
                    case 'pgk': 
                        soal.opsi.forEach((opt, i) => {
                            const isCorrect = Array.isArray(kunciData) && kunciData.includes(i);
                            createPgkOption(opt.text, isCorrect, opt.imageBase64);
                        }); 
                        break;
                    case 'bs': 
                        soal.opsi.forEach((opt, i) => {
                            // Kunci BS adalah array string 'true'/'false' atau boolean
                            let correctVal = 'true';
                            if (kunciData && kunciData[i] !== undefined) {
                                correctVal = String(kunciData[i]);
                            }
                            createBsStatement(opt.text, correctVal, opt.imageBase64);
                        }); 
                        break;
                    case 'esai-singkat': 
                        // Perbaikan: Masukkan kunci ke input text
                        kunciJawabanSingkat.value = kunciData || ''; 
                        break;
                }
                handleTypeChange();
                updateLivePreview();
                showNotification(`Soal dimuat. Kunci: ${JSON.stringify(kunciData)}`);
            }
            function collectSoalData() {
                const type = questionType.value;
                let opsi = []; 
                let kunci = null;
                let hasCorrectAnswer = false;

                switch(type) {
                    case 'pg': 
                        let correctIdx = -1;
                        pgList.querySelectorAll('.group').forEach((item, idx) => { 
                            const isCorrect = item.querySelector('input[type="radio"]').checked;
                            const textVal = item.querySelector('textarea').value.trim();
                            if(isCorrect) { hasCorrectAnswer = true; correctIdx = idx; }
                            opsi.push({ 
                                text: textVal, 
                                // TIDAK ADA isCorrect disini untuk publik
                                imageBase64: item.querySelector('.opsi-image-base64').value 
                            }); 
                        }); 
                        kunci = correctIdx;
                        break;
                    case 'pgk': 
                        let correctIndices = [];
                        pgkList.querySelectorAll('.group').forEach((item, idx) => { 
                            const isCorrect = item.querySelector('input[type="checkbox"]').checked;
                            const textVal = item.querySelector('textarea').value.trim();
                            if(isCorrect) { hasCorrectAnswer = true; correctIndices.push(idx); }
                            opsi.push({ 
                                text: textVal, 
                                imageBase64: item.querySelector('.opsi-image-base64').value 
                            }); 
                        }); 
                        kunci = correctIndices;
                        break;
                    case 'bs': 
                        // BS agak beda, setiap baris punya benar/salah sendiri.
                        // Kita simpan array jawaban 'true'/'false' sebagai kunci
                        let bsKeys = [];
                        bsList.querySelectorAll('.group').forEach(item => { 
                            hasCorrectAnswer = true; 
                            const textVal = item.querySelector('textarea').value.trim();
                            const correctVal = item.querySelector('select').value;
                            bsKeys.push(correctVal);
                            opsi.push({ 
                                text: textVal, 
                                imageBase64: item.querySelector('.opsi-image-base64').value 
                            }); 
                        }); 
                        kunci = bsKeys;
                        break;
                    case 'esai-singkat': 
                        kunci = kunciJawabanSingkat.value.trim(); 
                        if(kunci) hasCorrectAnswer = true;
                        break;
                    case 'esai-kompleks':
                        hasCorrectAnswer = true; // Manual review
                        break;
                }
                
				const mapelVal = metaMapel.value.trim();
                const kelasVal = metaKelas.value.trim();
                const kesulitanVal = metaKesulitan.value.trim();
                const babVal = metaBabInput.value.trim();
                const subBabVal = metaSubbabInput.value.trim();

                // Cek satu per satu
                if (!mapelVal) { showNotification('GAGAL: Mata Pelajaran wajib diisi!', true); metaMapel.focus(); return null; }
                if (!kelasVal) { showNotification('GAGAL: Kelas wajib diisi!', true); metaKelas.focus(); return null; }
                if (!kesulitanVal) { showNotification('GAGAL: Level Kognitif wajib diisi!', true); metaKesulitan.focus(); return null; }
                if (!babVal) { showNotification('GAGAL: BAB wajib diisi!', true); metaBabInput.focus(); return null; }
                if (!subBabVal) { showNotification('GAGAL: Sub BAB wajib diisi!', true); metaSubbabInput.focus(); return null; }
                if (!hasCorrectAnswer && type !== 'esai-kompleks') { showNotification('GAGAL: Tentukan KUNCI JAWABAN terlebih dahulu!', true); return null; }
                
                const naskahContent = editorVisual.innerHTML;
				const naskahBawahContent = editorBottom.innerHTML; // TAMBAHAN BARU

                const publicData = { 
                    type: type, 
                    metadata: { 
						mapel: mapelVal, // TAMBAHAN
                        kelas: metaKelas.value.trim(), 
                        kesulitan: metaKesulitan.value.trim(), 
                        bab: babVal, 
                        subbab: subBabVal 
                    }, 
                    skor: '1', 
                    naskah: naskahContent, 
					naskahBawah: naskahBawahContent, // TAMBAHAN BARU: Simpan teks bawah
                    naskahImage: naskahImageBase64.value, 
                    opsi: opsi, // Opsi bersih (tanpa kunci)
                    // Kunci tidak disimpan di sini
                    pembahasan: pembahasanToggle.checked ? pembahasanEditor.value : '', 
                    pembahasanImage: pembahasanToggle.checked ? pembahasanImageBase64.value : '', 
                    dibuatOleh: userId, 
                    tanggalUpdate: new Date().toISOString() 
                };
                
                return { publicData, kunci };
            }

            function renderLivePreviewHtml() {
                // 1. SIAPKAN DATA METADATA (UPDATE: Gunakan Tipe Soal, bukan Mapel)
                const type = questionType.value.toUpperCase(); // Ambil Tipe Soal
                const level = metaKesulitan.value || 'Level'; 
                const bab = metaBabInput.value || 'BAB';
                const subbab = metaSubbabInput.value || 'Sub BAB';

                // 2. FORMAT TAMPILAN LABEL BARU (Tipe | Level | BAB | Sub BAB)
                let metaHtml = `
                    <div class="flex flex-wrap items-center gap-2 text-[10px] font-bold text-indigo-600 dark:text-emerald-400 uppercase tracking-widest mb-4 border-b border-gray-100 dark:border-emerald-800 pb-2">
                        <span>${type}</span>
                        <span class="text-gray-300 dark:text-gray-600">|</span>
                        <span>${level}</span>
                        <span class="text-gray-300 dark:text-gray-600">|</span>
                        <span>${bab}</span>
                        <span class="text-gray-300 dark:text-gray-600">|</span>
                        <span class="text-gray-500 dark:text-emerald-500/70">${subbab}</span>
                    </div>
                `;

                // 3. RENDER NASKAH SOAL
                // Gunakan whitespace-pre-wrap agar enter terbaca, tapi hati-hati dengan MathJax
				// 1. TEKS ATAS
				let soalBodyHtml = `<div class="text-base leading-7 text-gray-700 dark:text-emerald-50 prose dark:prose-invert max-w-none mb-3">${editorVisual.innerHTML}</div>`;

				// 2. GAMBAR (DI TENGAH)
				if (naskahImageBase64.value) { 
					soalBodyHtml += `<div class="flex justify-center my-4"><img src="${naskahImageBase64.value}" class="soal-body-image rounded-lg shadow-sm max-h-[300px] object-contain border border-gray-100 dark:border-emerald-900"></div>`; 
				}

				// 3. TEKS BAWAH (BARU)
				if (editorBottom.innerHTML && editorBottom.innerHTML.trim() !== '') {
					soalBodyHtml += `<div class="text-base leading-7 text-gray-700 dark:text-emerald-50 prose dark:prose-invert max-w-none mt-3">${editorBottom.innerHTML}</div>`;
				}

				if(!editorVisual.innerHTML && !editorBottom.innerHTML && !naskahImageBase64.value) {
					soalBodyHtml = '<div class="text-gray-400 italic text-center p-4">Naskah soal belum diisi...</div>';
				}
                // 4. RENDER OPSI JAWABAN
                let kunciHtml = '';
                switch(questionType.value) {
                    case 'pg':
                        soalBodyHtml += '<div class="space-y-2 mt-3">';
                        pgList.querySelectorAll('.group').forEach((item, i) => {
                            const text = item.querySelector('textarea').value;
                            const img = item.querySelector('.opsi-image-base64').value;
                            const isCorrect = item.querySelector('input[type="radio"]').checked;
                            const letter = String.fromCharCode(65 + i);
                            const keyStyle = isCorrect ? 'bg-green-500 text-white border-green-600 ring-2 ring-green-200 dark:ring-green-900 shadow-lg scale-105' : 'bg-white dark:bg-cyber-800 text-gray-500 dark:text-gray-400 border-gray-200 dark:border-emerald-800';
                            
                            soalBodyHtml += `
                                <div class="flex items-start gap-3 group">
                                    <div class="flex-none w-8 h-8 rounded-lg border flex items-center justify-center font-bold text-sm transition-all duration-300 ${keyStyle}">${letter}</div>
                                    <div class="flex-1 py-1">
                                        <div class="preview-option-text text-gray-700 dark:text-emerald-100 whitespace-pre-wrap">${text || '...'}</div>
                                        ${img ? `<img src="${img}" class="h-24 object-contain rounded-lg mt-2 border border-gray-200 dark:border-emerald-700">` : ''}
                                    </div>
                                </div>`;
                        });
                        soalBodyHtml += '</div>';
                        break;
                     case 'pgk':
                        soalBodyHtml += '<div class="space-y-2 mt-3">';
                        pgkList.querySelectorAll('.group').forEach((item) => {
                            const text = item.querySelector('textarea').value;
                            const img = item.querySelector('.opsi-image-base64').value;
                            const isCorrect = item.querySelector('input[type="checkbox"]').checked;
                            const boxStyle = isCorrect ? 'bg-green-500 border-green-600' : 'bg-transparent border-gray-300 dark:border-emerald-700';

                            soalBodyHtml += `
                                <div class="flex items-start gap-3 group">
                                    <div class="flex-none w-5 h-5 mt-1 rounded border-2 transition-all duration-200 ${boxStyle}"></div>
                                    <div class="flex-1">
                                         <div class="preview-option-text text-gray-700 dark:text-emerald-100 whitespace-pre-wrap">${text || '...'}</div>
                                         ${img ? `<img src="${img}" class="h-24 object-contain rounded-lg mt-2 border border-gray-200 dark:border-emerald-700">` : ''}
                                    </div>
                                </div>`;
                        });
                        soalBodyHtml += '</div>';
                        break;
                    case 'bs':
                         soalBodyHtml += '<div class="mt-3 border rounded-lg overflow-hidden border-gray-200 dark:border-emerald-800"><table class="w-full text-sm text-left"><thead class="bg-gray-50 dark:bg-emerald-900/50 uppercase text-xs"><tr><th class="px-4 py-2">Pernyataan</th><th class="px-4 py-2 w-16 text-center">B</th><th class="px-4 py-2 w-16 text-center">S</th></tr></thead><tbody>';
                         bsList.querySelectorAll('.group').forEach(item => {
                            const text = item.querySelector('textarea').value;
                            const isCor = item.querySelector('select').value;
                            const img = item.querySelector('.opsi-image-base64').value;
                            const highlightB = isCor === 'true' ? 'bg-green-100 dark:bg-green-900/40 ring-2 ring-green-500' : '';
                            const highlightS = isCor === 'false' ? 'bg-green-100 dark:bg-green-900/40 ring-2 ring-green-500' : '';
                            soalBodyHtml += `<tr class="border-t dark:border-emerald-800"><td class="px-4 py-2"><div class="preview-option-text whitespace-pre-wrap">${text}</div>${img ? `<br><img src="${img}" class="h-12">` : ''}</td><td class="text-center"><div class="w-4 h-4 rounded-full border mx-auto ${highlightB}"></div></td><td class="text-center"><div class="w-4 h-4 rounded-full border mx-auto ${highlightS}"></div></td></tr>`;
                         });
                         soalBodyHtml += '</tbody></table></div>';
                        break;
                    case 'esai-singkat':
                        if (kunciJawabanSingkat.value) kunciHtml = `<div class="kunci-jawaban-box mt-4 p-3 bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200 rounded-lg border border-green-100 dark:border-green-800"><strong>Kunci:</strong> ${kunciJawabanSingkat.value}</div>`;
                        break;
                }

                // 5. RENDER PEMBAHASAN (AI Support & LaTeX Safe)
                let pembahasanHtml = '';
                if (pembahasanToggle.checked) {
                    let content = pembahasanEditor.value || '...';
                    
                    let imageHtml = '';
                    if (pembahasanImageBase64.value) imageHtml = `<img src="${pembahasanImageBase64.value}" class="max-h-40 rounded mt-2 block">`;
                    
                    pembahasanHtml = `
                    <div class="pembahasan-box mt-4 p-4 bg-indigo-50 dark:bg-cyber-900 border-l-4 border-indigo-500 rounded-r-lg">
                        <h4 class="font-bold text-indigo-700 dark:text-emerald-400 text-sm uppercase mb-1">Pembahasan</h4>
                        <div class="text-sm text-gray-700 dark:text-emerald-50 whitespace-pre-wrap leading-relaxed">${content}</div>
                        ${imageHtml}
                    </div>`;
                }

                return metaHtml + soalBodyHtml + kunciHtml + pembahasanHtml;
            }
            editorContainer.addEventListener('input', updateLivePreview);
            editorContainer.addEventListener('change', updateLivePreview);
            editorVisual.addEventListener('input', updateLivePreview);
            
            pembahasanToggle.addEventListener('change', () => { pembahasanContainer.style.display = pembahasanToggle.checked ? 'block' : 'none'; updateLivePreview(); });
            questionType.addEventListener('change', () => { handleTypeChange(); updateLivePreview(); });
            addPgOptionBtn.addEventListener('click', () => createPgOption(pgList.children.length === 0));
            addPgkOptionBtn.addEventListener('click', () => createPgkOption());
            addBsStatementBtn.addEventListener('click', () => createBsStatement());
            editorVisual.addEventListener('paste', async (e) => { 
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (const item of items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        e.preventDefault(); 
                        showNotification("Mendeteksi gambar dari clipboard...", false);
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const compressed = await compressImage(event.target.result);
                            loadImageInput('naskah', compressed);
                            updateLivePreview();
                            showNotification('Gambar ditempel & dikompresi!');
                        };
                        reader.readAsDataURL(blob);
                        break; 
                    }
                }
            });

			// Agar paste di editor bawah juga mentrigger upload gambar
			editorBottom.addEventListener('paste', async (e) => {
				// Gunakan logika yang sama persis dengan editorVisual
				const items = (e.clipboardData || e.originalEvent.clipboardData).items;
				for (const item of items) {
					if (item.kind === 'file' && item.type.startsWith('image/')) {
						e.preventDefault(); 
						showNotification("Mendeteksi gambar (Editor Bawah)...", false);
						const blob = item.getAsFile();
						const reader = new FileReader();
						reader.onload = async (event) => {
							const compressed = await compressImage(event.target.result); // Pastikan fungsi compressImage bisa diakses
							loadImageInput('naskah', compressed);
							updateLivePreview();
						};
						reader.readAsDataURL(blob);
						break; 
					}
				}
			});

            editorContainer.addEventListener('click', (e) => {
                if (e.target.closest('.remove-btn')) { e.target.closest('.group').remove(); updateLivePreview(); }
                if (e.target.classList.contains('url-btn')) {
                    const targetId = e.target.dataset.targetId; const target = e.target.dataset.target;
                    const imageUrl = prompt("Masukkan URL gambar (https://...):");
                    if (imageUrl) { if (targetId) loadImageInput(targetId, imageUrl); else if (target) loadImageInput(target, imageUrl); updateLivePreview(); }
                }
                if (e.target.classList.contains('remove-image-btn')) {
                    const targetId = e.target.dataset.targetId; const target = e.target.dataset.target;
                    if (targetId) clearImageInput(targetId); else if (target) clearImageInput(target); updateLivePreview();
                }
            });
            editorContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('file-input')) {
                    const file = e.target.files[0]; 
                    if (!file) return;
                    showNotification("Memproses & mengompresi gambar...", false);
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                         const targetId = e.target.id.replace('file-', '').replace('pembahasan-image-input','').replace('naskah-image-input','');
                         const compressedBase64 = await compressImage(ev.target.result);
                         if (e.target.id === 'naskah-image-input') loadImageInput('naskah', compressedBase64);
                         else if (e.target.id === 'pembahasan-image-input') loadImageInput('pembahasan', compressedBase64);
                         else loadImageInput(targetId, compressedBase64);
                         updateLivePreview();
                         showNotification("Gambar berhasil diupload (Terkecil).");
                    };
                    reader.readAsDataURL(file);
                }
            });
            saveBankSoalBtn.addEventListener('click', async () => {
                const soalDataFull = collectSoalData(); 
                if (!soalDataFull) return;
                
                const { publicData, kunci } = soalDataFull;
                
                // SIMPAN STATUS EDIT SEBELUM DI-CLEAR
                const wasEditing = currentEditingSoalId !== null;

                saveBankSoalBtn.disabled = true; 
                const originalText = saveBankSoalBtn.textContent; 
                saveBankSoalBtn.textContent = 'Menyimpan Aman...';
                
                try {
                    await runTransaction(db, async (transaction) => {
                        let soalRef;
                        let privatRef;

                        if (currentEditingSoalId) { 
                            soalRef = doc(bankSoalCollectionRef, currentEditingSoalId);
                            privatRef = doc(db, 'bank_soal_privat', currentEditingSoalId);
                        } else { 
                            soalRef = doc(collection(db, "bank_soal"));
                            privatRef = doc(db, "bank_soal_privat", soalRef.id);
                        }
                        
                        // Simpan Data Publik
                        transaction.set(soalRef, publicData);

                        // Simpan Data Privat
                        transaction.set(privatRef, {
                            kunci: kunci,
                            tipe: publicData.type,
                            updated: new Date().toISOString()
                        });
                    });
                    
                    showNotification('Soal tersimpan aman (Split Database)!'); 
                    
                    clearEditor(); // Reset form
                    loadExistingMetadataOptions(); 
                    
                    // JIKA TADINYA EDIT, KEMBALI KE MODAL
                    if (wasEditing) {
                        showModal(); 
                        // Opsional: Klik tombol cari otomatis agar list terupdate
                        if(searchFirebaseBtn) searchFirebaseBtn.click();
                    }

                } catch (error) { 
                    showNotification(`Gagal simpan: ${error.message}`, true); 
                } finally { 
                    saveBankSoalBtn.disabled = false; 
                    saveBankSoalBtn.innerHTML = originalText; 
                }
            });
            clearEditorBtn.addEventListener('click', () => {
                // SIMPAN STATUS DULU SEBELUM CLEAR
                const wasEditing = currentEditingSoalId !== null;
                
                clearEditor(); 
                
                if (wasEditing) {
                    // JIKA BATAL EDIT, BUKA KEMBALI MODAL
                    showModal(); 
                    showNotification('Edit dibatalkan, kembali ke Bank Soal.');
                } else {
                    showNotification('Editor dibersihkan.');
                }
            });
            
            const showModal = () => { bankSoalModal.classList.remove('hidden'); populateFilterDropdowns(); };
            const hideModal = () => bankSoalModal.classList.add('hidden');
            openBankSoalBtn.addEventListener('click', showModal);
            closeBankSoalModalBtn.addEventListener('click', hideModal);

            let filterBabSubBabMap = {}; 
            let allSubBabsList = new Set();

            async function populateFilterDropdowns() {
                if (!bankSoalCollectionRef) return;
                const filters = {
					mapel: document.getElementById('filter-mapel'), // TAMBAHAN
                    tipe: document.getElementById('filter-tipe'), 
                    kelas: document.getElementById('filter-kelas'), 
                    kesulitan: document.getElementById('filter-kesulitan'), 
                    bab: document.getElementById('filter-bab'), 
                    subbab: document.getElementById('filter-subbab') 
                };
                
                Object.values(filters).forEach(s => { if(s) s.innerHTML = `<option value="">${s.options[0].text}</option>`; });
                
                const typeOptions = [
                    { v: 'pg', l: 'PG' },
                    { v: 'pgk', l: 'PGK' },
                    { v: 'bs', l: 'BS' },
                    { v: 'esai-singkat', l: 'Essai Singkat' },
                    { v: 'esai-kompleks', l: 'Essai Kompleks (Uraian)' }
                ];
                typeOptions.forEach(o => filters.tipe.add(new Option(o.l, o.v)));

                const snap = await getDocs(query(bankSoalCollectionRef));
                const sets = { mapel: new Set(), kelas: new Set(), kesulitan: new Set(), bab: new Set() };
                
                filterBabSubBabMap = {};
                allSubBabsList = new Set();

                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    if(d.metadata) {
						if(d.metadata.mapel) sets.mapel.add(d.metadata.mapel); // TAMBAHAN
                        if(d.metadata.kelas) sets.kelas.add(d.metadata.kelas); 
                        if(d.metadata.kesulitan) sets.kesulitan.add(d.metadata.kesulitan); 
                        if(d.metadata.bab) {
                            sets.bab.add(d.metadata.bab); 
                            if(!filterBabSubBabMap[d.metadata.bab]) filterBabSubBabMap[d.metadata.bab] = new Set();
                            if(d.metadata.subbab) {
                                filterBabSubBabMap[d.metadata.bab].add(d.metadata.subbab);
                                allSubBabsList.add(d.metadata.subbab); 
                            }
                        }
                    }
                });
                
				sets.mapel.forEach(v => filters.mapel.add(new Option(v, v))); // TAMBAHAN
                sets.kelas.forEach(v => filters.kelas.add(new Option(v, v))); 
                sets.kesulitan.forEach(v => filters.kesulitan.add(new Option(v, v))); 
                sets.bab.forEach(v => filters.bab.add(new Option(v, v))); 
                allSubBabsList.forEach(v => filters.subbab.add(new Option(v, v)));
            }

            document.getElementById('filter-bab').addEventListener('change', function() {
                const selectedBab = this.value;
                const subSelect = document.getElementById('filter-subbab');
                subSelect.innerHTML = '<option value="">Semua Sub</option>';
                
                let targetSubBabs = new Set();
                if (selectedBab && filterBabSubBabMap[selectedBab]) {
                    targetSubBabs = filterBabSubBabMap[selectedBab];
                } else {
                    targetSubBabs = allSubBabsList;
                }
                targetSubBabs.forEach(v => {
                    subSelect.add(new Option(v, v));
                });
            });

            searchFirebaseBtn.addEventListener('click', async () => {
                bankSoalListContainer.innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div><p class="text-xs mt-2 text-gray-500">Mengambil soal & kunci...</p></div>';
                try {
                    const filters = {
                        mapel: document.getElementById('filter-mapel').value,
                        tipe: document.getElementById('filter-tipe').value,
                        kelas: document.getElementById('filter-kelas').value,
                        kesulitan: document.getElementById('filter-kesulitan').value,
                        bab: document.getElementById('filter-bab').value,
                        subbab: document.getElementById('filter-subbab').value
                    };

                    let q = query(bankSoalCollectionRef); 
                    const snapshot = await getDocs(q);
                    bankSoalListContainer.innerHTML = ''; 
                    tempBankSoalResults = [];
                    
                    let hasResults = false;

                    // Gunakan for...of loop agar bisa await di dalamnya (Parallel Fetching lebih baik tapi ini lebih aman urutannya)
                    const promises = snapshot.docs.map(async (docSnap) => {
                        const d = docSnap.data();
                        
                        // Client-side filtering
                        if (filters.mapel && d.metadata?.mapel !== filters.mapel) return null;
                        if (filters.tipe && d.type !== filters.tipe) return null;
                        if (filters.kelas && d.metadata?.kelas !== filters.kelas) return null;
                        if (filters.kesulitan && d.metadata?.kesulitan !== filters.kesulitan) return null;
                        if (filters.bab && d.metadata?.bab !== filters.bab) return null;
                        if (filters.subbab && d.metadata?.subbab !== filters.subbab) return null;

                        d.firebaseId = docSnap.id;
                        
                        // PERBAIKAN PENTING: Ambil Kunci Jawaban dari Private Collection
                        try {
                            const privRef = doc(db, 'bank_soal_privat', d.firebaseId);
                            const privSnap = await getDoc(privRef);
                            if (privSnap.exists()) {
                                d.kunci = privSnap.data().kunci; // Masukkan kunci ke objek data untuk keperluan Admin
                            }
                        } catch (err) {
                            console.warn("Gagal ambil kunci untuk", d.firebaseId);
                        }

                        return d;
                    });

                    const results = await Promise.all(promises);
                    const validResults = results.filter(r => r !== null);

                    if (validResults.length === 0) {
                        bankSoalListContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada soal ditemukan.</p>';
                        return;
                    }

                    // Render Hasil
                    validResults.forEach((d, index) => {
                        hasResults = true;
                        tempBankSoalResults.push(d); // Simpan ke memori global untuk tombol Edit
						const totalDisplay = document.getElementById('total-soal-display');
						const countValue = document.getElementById('count-value');
						if(totalDisplay && countValue) {
							totalDisplay.classList.remove('hidden');
							countValue.innerText = validResults.length;
						}
                        const item = document.createElement('div');
                        item.className = 'bg-[#fffbf7] dark:bg-cyber-800 p-4 rounded-xl border border-gray-100 dark:border-emerald-900 hover:border-indigo-500 dark:hover:border-emerald-500 transition-all group cursor-pointer relative';
                        
                        // Tanda jika kunci berhasil diambil
                        const keyIndicator = d.kunci !== undefined ? '<span class="text-green-500 text-[10px] ml-2">â— Key Loaded</span>' : '<span class="text-red-400 text-[10px] ml-2">â— No Key</span>';

                        item.innerHTML = `
                            <div class="flex justify-between items-start gap-4 h-full">
                                
                                <!-- Nomor Urut -->
                                <div class="flex-none w-8 pt-1">
                                    <span class="text-lg font-bold text-gray-300 dark:text-emerald-800 select-none">#${index + 1}</span>
                                </div>

                                <div class="flex-1 min-w-0 py-1">
                                    <p class="text-sm text-gray-800 dark:text-emerald-50 line-clamp-2 mb-2 leading-relaxed">${(d.naskah || '...').substring(0,150)}</p>
                                    
                                    <!-- LABEL LABEL BARU (Tipe, Level, Bab, Sub) -->
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <span class="text-[10px] bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 px-2 py-1 rounded font-bold border border-blue-200 dark:border-blue-800">
                                            ${(d.type||'?').toUpperCase()}
                                        </span>
                                        <span class="text-[10px] bg-pink-100 text-pink-700 dark:bg-pink-900 dark:text-pink-300 px-2 py-1 rounded font-bold border border-pink-200 dark:border-pink-800">
                                            ${d.metadata?.kesulitan || 'Level?'}
                                        </span>
                                        <span class="text-[10px] bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 px-2 py-1 rounded border border-gray-200 dark:border-gray-600">
                                            ${d.metadata?.bab || 'Bab?'}
                                        </span>
                                        <span class="text-[10px] bg-teal-100 text-teal-700 dark:bg-teal-900 dark:text-teal-300 px-2 py-1 rounded border border-teal-200 dark:border-teal-800">
                                            ${d.metadata?.subbab || 'Sub?'}
                                        </span>
                                        ${keyIndicator}
                                    </div>
                                </div>

                                <div class="flex flex-col gap-2 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button class="preview-btn bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-300 p-2 rounded-lg hover:bg-blue-200 border border-blue-200 dark:border-blue-800 transition-colors" title="Lihat Soal">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                    </button>
                                    <button class="load-btn bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 p-2 rounded-lg hover:bg-indigo-200 border border-indigo-200 dark:border-indigo-800 transition-colors" title="Edit">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </button>
                                    <button class="delete-btn bg-rose-100 dark:bg-rose-900/50 text-rose-600 dark:text-rose-300 p-2 rounded-lg hover:bg-rose-200 border border-rose-200 dark:border-rose-800 transition-colors" title="Hapus">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>`;
                        
                        // Event Listeners (Sama seperti sebelumnya)
                        item.querySelector('.preview-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            const content = document.getElementById('preview-item-content'); 
                            content.innerHTML = generateStaticPreview(d); // Sekarang d sudah punya d.kunci!
                            document.getElementById('previewItemModal').classList.remove('hidden');
                            if(window.MathJax) MathJax.typesetPromise([content]);
                        });
                        item.querySelector('.load-btn').addEventListener('click', (e) => { e.stopPropagation(); populateEditor(d); hideModal(); });
                        
                        const deleteBtn = item.querySelector('.delete-btn');
                        deleteBtn.addEventListener('click', async (e) => { 
                            e.stopPropagation();
                            if (deleteBtn.dataset.confirm === "true") {
                                try { 
                                    await deleteDoc(doc(bankSoalCollectionRef, d.firebaseId)); 
                                    await deleteDoc(doc(db, 'bank_soal_privat', d.firebaseId)); // Hapus privat juga
                                    item.remove(); 
                                    showNotification('Soal berhasil dihapus.'); 
                                } catch(err) { console.error(err); showNotification('Gagal hapus: ' + err.message, true); }
                            } else {
                                deleteBtn.dataset.confirm = "true"; const originalHtml = deleteBtn.innerHTML;
                                deleteBtn.innerHTML = '<span class="text-[10px] font-bold px-1">Yakin?</span>';
                                deleteBtn.className = "delete-btn bg-red-600 text-white p-1.5 rounded-lg hover:bg-red-700 transition-all shadow-lg transform scale-110 ring-2 ring-red-300";
                                setTimeout(() => { deleteBtn.dataset.confirm = "false"; deleteBtn.innerHTML = originalHtml; deleteBtn.className = "delete-btn bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 p-1.5 rounded-lg hover:bg-rose-200 dark:hover:bg-rose-900 transition-all"; }, 3000);
                            }
                        });

                        bankSoalListContainer.appendChild(item);
                    });

                } catch (e) { 
                    console.error(e);
                    bankSoalListContainer.innerHTML = `<p class="text-red-500 text-center py-4">Error: ${e.message}</p>`; 
                }
            });           

            clearEditor();
        });
    </script>
</body>
</html>
